<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-eval' https://accounts.google.com;">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ/‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° ‚Äì ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà (Compact)</title>

<!-- Google Identity -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
  :root{
    --bg:#f8fafc; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
    --brand:#3b82f6; --paper:#ffffff; --radius:12px;
    --danger:#ef4444; --ghost:#eef2ff; --ok:#22c55e;
    --shadow-sm: 0 1px 1px rgb(0 0 0 / 0.05);
    --shadow-md: 0 2px 6px -2px rgb(0 0 0 / 0.12);
    --h-pad:10px; --v-pad:8px;               /* scale ‡∏£‡∏∞‡∏¢‡∏∞‡∏Ç‡∏≠‡∏ö‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
    --ctl-h:34px;                             /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏õ‡∏∏‡πà‡∏°/‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï */
    --font-base:14px; --font-small:12.5px;    /* ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
    --thumb:48px;                              /* ‡∏£‡∏π‡∏õ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Sarabun",system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai",Arial,sans-serif;line-height:1.55;font-size:var(--font-base)}
  a{color:var(--brand);text-decoration:none}
  header{position:sticky;top:0;z-index:10;background:var(--paper);border-bottom:1px solid var(--line);box-shadow:var(--shadow-sm)}
  .wrap{max-width:980px;margin:auto;padding:10px 12px}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;min-height:44px}

  /* ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ó‡∏£‡∏•‡πÅ‡∏ö‡∏ö compact */
  input[type="search"], select, textarea, input[type="text"]{
    flex:1; height:var(--ctl-h);
    padding:0 10px; border:1px solid var(--line); border-radius:8px; background:#fafafa; font-size:13.5px;
    transition:border-color .15s ease, box-shadow .15s ease;
  }
  textarea{height:auto;min-height:84px;padding:8px 10px}
  input:focus, select:focus, textarea:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 2px #bfdbfe}

  /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
  button{
    border:0;border-radius:8px;padding:0 12px;height:var(--ctl-h);
    background:var(--brand);color:#fff;cursor:pointer;font-weight:700;font-size:13.5px;
    transition:background .15s ease, box-shadow .15s ease, transform .15s ease;
  }
  button.ghost{background:#e9eefb;color:#1e3a8a}
  button.danger{background:var(--danger)}
  button[disabled]{opacity:.65;cursor:not-allowed}
  @media (hover:hover){
    button:hover:not([disabled]){box-shadow:var(--shadow-md)}
  }

  /* ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ô‡∏ß‡∏ü‡∏≠‡∏£‡∏±‡πà‡∏° */
  .search{flex:1;display:flex;gap:6px;align-items:center}
  .sign{display:flex;gap:6px;align-items:center}
  .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover}

  /* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡∏±‡πà‡∏° (‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£) */
  .list{display:grid;gap:10px;margin:12px 0}
  .card{
    background:var(--paper); border:1px solid var(--line); border-radius:var(--radius);
    padding:10px; display:grid; grid-template-columns:var(--thumb) 1fr; gap:10px;
    box-shadow:var(--shadow-sm);
  }
  /* ‡∏•‡∏î/‡∏õ‡∏¥‡∏î‡∏ó‡∏£‡∏≤‡∏ô‡∏™‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ */
  @media (hover:hover){
    .card:hover{box-shadow:var(--shadow-md)}
  }
  .thumb{
    width:var(--thumb); height:var(--thumb); aspect-ratio:1/1;
    border-radius:8px; object-fit:cover; background:#eee; flex:0 0 var(--thumb);
  }
  .title{font-weight:700;margin:0 0 2px 0;font-size:0.98rem;line-height:1.35}
  .meta{font-size:var(--font-small);color:var(--muted)}
  .body{margin-top:6px;white-space:pre-wrap;font-size:13.5px}
  .actions{display:flex;gap:6px;align-items:center;margin-top:8px}
  .chip{
    border:1px solid var(--line); background:#fff; color:#111;
    padding:4px 8px; border-radius:999px; font-size:12.5px; height:28px; display:inline-flex; align-items:center;
  }
  .chip.active{background:#e0e7ff;border-color:#a5b4fc;color:#3730a3;font-weight:600}
  .chip[disabled]{opacity:.55;cursor:not-allowed}

  /* ‡πÄ‡∏û‡∏à‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î */
  .pager{display:flex;gap:6px;justify-content:center;align-items:center;margin:14px 0}
  #pageInfo{font-size:12.5px;padding:6px 10px;border-radius:8px;background:#eef2ff;color:#1e40af}

  /* ‡πÑ‡∏î‡∏≠‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡∏£‡∏π‡∏õ & ‡πÄ‡∏ö‡∏≤ */
  .dialog-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:12px;z-index:20}
  .dialog{background:var(--paper);border-radius:12px;max-width:520px;width:100%;padding:14px;border:1px solid var(--line);box-shadow:var(--shadow-md)}
  .dialog h3{margin:0 0 10px 0}
  .grid{display:grid;gap:8px}

  /* ‡∏•‡∏î motion ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏î‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô */
  @media (prefers-reduced-motion: reduce){
    *{transition:none !important}
  }

  /* ‡∏£‡∏µ‡∏™‡∏õ‡∏≠‡∏ô‡∏ã‡∏µ‡∏ü */
  @media (max-width:640px){
    .wrap{padding:10px}
    .card{grid-template-columns:40px 1fr}
    :root{ --thumb:40px; }
    .title{font-size:0.95rem}
  }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="toolbar">
      <div class="search">
        <input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á..." />
        <select id="catFilter">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>
        </select>
        <button class="ghost" id="btnSearch" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="sign">
        <img id="avatar" class="avatar" src="" alt="" style="display:none">
        <div id="signin"></div>
        <button id="btnSignOut" class="ghost" style="display:none">‡∏≠‡∏≠‡∏Å</button>
        <button id="btnAdd" disabled>‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap" role="main">
  <div id="list" class="list" aria-live="polite"></div>
  <div class="pager">
    <button id="prev">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    <div id="pageInfo" class="ghost"></div>
    <button id="next">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
  </div>
</main>

<!-- Dialog -->
<div id="dlg" class="dialog-backdrop" role="dialog" aria-modal="true">
  <div class="dialog">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <h3 id="dlgTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
      <button id="closeDlg" class="ghost" aria-label="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="grid">
      <input id="title" type="text" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠"/>
      <textarea id="body" rows="5" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea>
      <select id="postCategory"><option value="">(‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‚Ä¶)</option></select>
      <input id="file" type="file" accept="image/*"/>
      <button id="save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<script>
  // ======= ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì =======
  const WEB_APP_BASE = 'https://script.google.com/macros/s/AKfycbySSYD2QpQxWsX7Len5J2k_PlFdgdqZyZV7q-TiBXXj9bkg93hfsZYCT9DBvlWi7slMJg/exec';
  const CLIENT_ID = '986811661821-d65agv1s2rmdcq743nif06a3ek0a01b5.apps.googleusercontent.com';
  // ===========================================

  let idToken = '';
  let me = null;
  let page = 1;
  const pageSize = 10;
  let editingId = null;

  const EMOJIS = ['üëç','‚ù§Ô∏è','üòÇ','üëè'];

  /* Utilities */
  const $ = (id)=>document.getElementById(id);
  function toQS(obj){return Object.entries(obj).map(([k,v])=>encodeURIComponent(k)+'='+encodeURIComponent(v)).join('&')}
  function showError(msg, extra){ console.error('[ERROR]', msg, extra||''); Swal.fire({icon:'error',title:msg,text:extra||''}); }
  function showSuccess(msg){ Swal.fire({icon:'success',title:msg,showConfirmButton:false,timer:1200}); }

  function setSignedInUI(on){
    const avatar = $('avatar'), signin=$('signin'), btnAdd=$('btnAdd'), btnSignOut=$('btnSignOut');
    if(on){
      signin.style.display='none'; btnSignOut.style.display='inline-block'; btnAdd.disabled=false;
      avatar.style.display = me && me.picture ? 'block' : 'none';
      if(me && me.picture) avatar.src = me.picture;
    }else{
      signin.style.display='block'; btnSignOut.style.display='none'; btnAdd.disabled=true; avatar.style.display='none';
    }
  }

  /* Google Identity */
  window.onload = async function(){
    try{
      const savedToken = localStorage.getItem('idToken');
      const savedMe = localStorage.getItem('me');
      if(savedToken) idToken=savedToken;
      if(savedMe) me=JSON.parse(savedMe);
      if(idToken && me && me.email) setSignedInUI(true);
    }catch(e){}
    google.accounts.id.initialize({ client_id: CLIENT_ID, callback: handleCredentialResponse, auto_select:false });
    google.accounts.id.renderButton($('signin'), { theme:"outline", size:"medium", text:"signin_with", locale:"th" });

    await loadCategoriesToUI();

    if(idToken){
      try{ await fetchMe(); if(me && me.email){ setSignedInUI(true); loadList(); } else setSignedInUI(false); }
      catch(e){ setSignedInUI(false); }
    }
  };

  async function handleCredentialResponse(resp){
    if(!resp || !resp.credential){ showError('Sign in ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÑ‡∏°‡πà‡∏û‡∏ö credential'); return; }
    idToken = resp.credential;
    await fetchMe();
    if(me && me.email){
      localStorage.setItem('idToken', idToken);
      localStorage.setItem('me', JSON.stringify(me));
      setSignedInUI(true); showSuccess('‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); loadList();
    }else{ setSignedInUI(false); showError('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'); }
  }

  $('btnSignOut').addEventListener('click', ()=>{
    try{ google.accounts.id.disableAutoSelect(); }catch(e){}
    idToken=''; me=null;
    localStorage.removeItem('idToken'); localStorage.removeItem('me');
    setSignedInUI(false); $('list').innerHTML=''; $('pageInfo').textContent='';
  });

  async function fetchMe(){
    const url = WEB_APP_BASE + '?' + toQS({action:'me', idToken});
    const r = await fetch(url);
    const j = await r.json().catch(()=>null);
    if(!r.ok || (j && j.error)){ me=null; return; }
    me = j || null;
  }

  /* Categories */
  async function loadCategoriesToUI(){
    try{
      const url = WEB_APP_BASE + '?' + toQS({action:'categories', idToken: idToken || 'dummy'});
      const r = await fetch(url);
      const j = await r.json().catch(()=>null);
      if(!r.ok || !j || j.error) throw new Error(j ? JSON.stringify(j) : 'Cannot load categories');

      const filterSel = $('catFilter'); j.categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; filterSel.appendChild(o); });
      filterSel.addEventListener('change', ()=>{ page=1; loadList(); });

      const catSel = $('postCategory'); catSel.innerHTML=''; j.categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; catSel.appendChild(o); });
    }catch(err){ showError('‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', err.message); }
  }

  /* Reactions */
  async function fetchReactions(postId){
    const url = WEB_APP_BASE + '?' + toQS({action:'reactions', idToken, postId});
    const r = await fetch(url); const j = await r.json().catch(()=>null);
    if(!r.ok || !j || j.error) throw new Error(j?JSON.stringify(j):'');
    EMOJIS.forEach(e=>{ if(typeof j.counts[e] !== 'number') j.counts[e]=0; });
    return j;
  }
  async function sendReaction(postId, emoji){
    const form = new URLSearchParams();
    form.set('action','react'); form.set('idToken', idToken); form.set('postId', postId); form.set('emoji', emoji);
    const r = await fetch(WEB_APP_BASE, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:form.toString()});
    const j = await r.json().catch(()=>null);
    if(!r.ok || !j || j.error) throw new Error(j?JSON.stringify(j):'');
    EMOJIS.forEach(e=>{ if(typeof j.counts[e] !== 'number') j.counts[e]=0; });
    return j;
  }
  function renderReactions(container, postId, data){
    container.innerHTML='';
    EMOJIS.forEach(e=>{
      const b=document.createElement('button');
      b.className='chip'+(data.mine===e?' active':''); b.textContent=`${e} ${data.counts[e]||0}`;
      b.addEventListener('click', async (evt)=>{
        const all=evt.target.closest('.actions').querySelectorAll('.chip'); all.forEach(c=>c.disabled=true);
        try{ const updated=await sendReaction(postId, e); renderReactions(container, postId, updated); }
        catch(err){ showError('‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', String(err)); }
        finally{ const news=evt.target.closest('.actions').querySelectorAll('.chip'); news.forEach(c=>c.disabled=false); }
      });
      container.appendChild(b);
    });
  }

  /* List / Render */
  async function loadList(){
    if(!idToken){ showError('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ'); return; }
    const listEl=$('list');
    listEl.innerHTML='<div style="text-align:center;padding:16px;color:var(--muted);font-size:13px">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';

    const q=$('q').value.trim(); const category=$('catFilter').value||'';
    const url = WEB_APP_BASE + '?' + toQS({action:'list', idToken, q, page, pageSize, category});
    try{
      const r=await fetch(url); const j=await r.json().catch(()=>null);
      if(!r.ok || !j || j.error) throw new Error(j ? JSON.stringify(j) : 'Response not OK');
      renderList(j);
    }catch(err){
      listEl.innerHTML=''; showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', err.message);
    }
  }

  function renderList(data){
    const list=$('list'); list.innerHTML='';
    if(!data.items || data.items.length===0){
      list.innerHTML='<div style="text-align:center;padding:16px;color:var(--muted);font-size:13px">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    }
    (data.items||[]).forEach(item=>{
      const card=document.createElement('div'); card.className='card';

      const img=document.createElement('img');
      img.className='thumb'; img.loading='lazy'; img.decoding='async';
      img.width=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--thumb'))||48;
      img.height=img.width;
      img.src = item.imageUrl ? item.imageUrl : (item.imageId ? ('https://lh3.googleusercontent.com/d/'+item.imageId) : 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=');
      img.alt='';

      const right=document.createElement('div');
      const h=document.createElement('h4'); h.className='title'; h.textContent=item.title||'(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)';

      const meta=document.createElement('div'); meta.className='meta';
      const owner=item.ownerEmail?` ‚Ä¢ ‡πÇ‡∏î‡∏¢ ${item.ownerEmail}`:''; const cat=item.category?` ‚Ä¢ ‡∏´‡∏°‡∏ß‡∏î ${item.category}`:'';
      meta.textContent=(item.createdAt ? new Date(item.createdAt).toLocaleString() : '') + owner + cat;

      const body=document.createElement('div'); body.className='body';
      const text=(item.body||''); body.textContent = text.length>160 ? text.slice(0,160)+'‚Ä¶' : text;

      const actions=document.createElement('div'); actions.className='actions';
      const reacts=document.createElement('div'); reacts.style.display='flex'; reacts.style.gap='6px';
      (async()=>{ try{ const rx=await fetchReactions(item.id); renderReactions(reacts, item.id, rx);}catch(e){} })();
      actions.appendChild(reacts);

      if(me && item.ownerEmail && me.email===item.ownerEmail){
        const btnGroup=document.createElement('div'); btnGroup.style.marginLeft='auto'; btnGroup.style.display='flex'; btnGroup.style.gap='6px';
        const editBtn=document.createElement('button'); editBtn.className='ghost'; editBtn.textContent='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'; editBtn.addEventListener('click', ()=>openEdit(item));
        const delBtn=document.createElement('button'); delBtn.className='danger'; delBtn.textContent='‡∏•‡∏ö'; delBtn.addEventListener('click', ()=>doDelete(item.id));
        btnGroup.appendChild(editBtn); btnGroup.appendChild(delBtn); actions.appendChild(btnGroup);
      }

      right.appendChild(h); right.appendChild(meta); right.appendChild(body); right.appendChild(actions);
      card.appendChild(img); card.appendChild(right); list.appendChild(card);
    });

    $('pageInfo').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${data.page} / ${data.totalPages} ‚Äì ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    $('prev').disabled = data.page<=1; $('next').disabled = data.page>=data.totalPages;
  }

  /* Search & Pager (debounce ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢) */
  let searchTimer=null;
  $('btnSearch').addEventListener('click', ()=>{ page=1; loadList(); });
  $('q').addEventListener('input', ()=>{
    clearTimeout(searchTimer); searchTimer=setTimeout(()=>{ page=1; loadList(); }, 350);
  });
  $('q').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); page=1; loadList(); }});
  $('prev').addEventListener('click', ()=>{ if(page>1){ page--; loadList(); }});
  $('next').addEventListener('click', ()=>{ page++; loadList(); });

  /* Dialog */
  const dlg=$('dlg'), dlgTitle=$('dlgTitle');
  $('btnAdd').addEventListener('click', openCreate);
  $('closeDlg').addEventListener('click', ()=> dlg.style.display='none');

  function openCreate(){
    editingId=null; dlgTitle.textContent='‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    $('title').value=''; $('body').value=''; $('file').value='';
    const catSel=$('postCategory'); if(catSel && catSel.options.length) catSel.selectedIndex=0;
    dlg.style.display='flex';
  }
  function openEdit(item){
    editingId=item.id; dlgTitle.textContent='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå';
    $('title').value=item.title||''; $('body').value=item.body||''; $('file').value='';
    const catSel=$('postCategory'); if(catSel){ const ix=[...catSel.options].findIndex(o=>o.value===item.category); catSel.selectedIndex= ix>=0 ? ix : 0; }
    dlg.style.display='flex';
  }

  $('save').addEventListener('click', async (evt)=>{
    if(!idToken){ showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ'); return; }
    const title=$('title').value.trim(); const body=$('body').value.trim(); const file=$('file').files[0];
    const category=($('postCategory')?.value||'').trim();
    if(!title){ showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠'); return; }

    const saveBtn=evt.target; const text=saveBtn.textContent; saveBtn.disabled=true; saveBtn.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶';
    try{
      let imageData=''; if(file) imageData=await fileToDataURL(file);
      const form=new URLSearchParams(); form.set('idToken', idToken); form.set('title', title); form.set('body', body);
      if(category) form.set('category', category); if(imageData) form.set('imageData', imageData);
      if(editingId){ form.set('action','update'); form.set('id', editingId);} else { form.set('action','create'); }
      const r=await fetch(WEB_APP_BASE,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:form.toString()});
      const j=await r.json().catch(()=>null); if(!r.ok || (j && j.error)) throw new Error(j?JSON.stringify(j):'Save failed');
      dlg.style.display='none'; showSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); page=1; loadList();
    }catch(err){ showError(`${editingId?'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç':'‡∏™‡∏£‡πâ‡∏≤‡∏á'} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, err.message); }
    finally{ saveBtn.disabled=false; saveBtn.textContent=text; }
  });

  async function doDelete(id){
    if(!idToken){ showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ'); return; }
    const result=await Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',text:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÅ‡∏≠‡∏Ñ‡∏ä‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£!',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33',cancelButtonColor:'#3085d6',confirmButtonText:'‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!',cancelButtonText:'‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'});
    if(result.isConfirmed){
      try{
        const form=new URLSearchParams(); form.set('action','delete'); form.set('idToken', idToken); form.set('id', id);
        const r=await fetch(WEB_APP_BASE,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:form.toString()});
        const j=await r.json().catch(()=>null); if(!r.ok || (j && j.error)) throw new Error(j?JSON.stringify(j):'Delete failed');
        showSuccess('‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); loadList();
      }catch(err){ showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', err.message); }
    }
  }

  function fileToDataURL(file){
    return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.onerror=reject; fr.readAsDataURL(file); });
  }
</script>
</body>
</html>
