<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

<!-- ‚úÖ CSP ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï inline script ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Apps Script ‡πÑ‡∏î‡πâ -->
<meta http-equiv="Content-Security-Policy"
  content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://script.google.com https://script.googleusercontent.com;
    connect-src 'self' https://script.google.com https://script.googleusercontent.com https://*.googleusercontent.com https://www.googleapis.com;
    img-src 'self' data: blob: https://lh3.googleusercontent.com https://*.googleusercontent.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com;
    base-uri 'self';
  ">

<title>‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‚Äì‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á ‚Äì Demo Client</title>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#333333; --muted:#6c757d; --bg:#f4f4f4; --card:#ffffff; --line:#e0e0e0;
  --brand:#1a3a5e; --brand-2:#142d4a; --ok:#28a745; --danger:#dc3545; --ring:#d9e6f3; --radius:8px;
  --shadow:0 6px 16px -8px rgba(0,0,0,.15);
  --chip:#e9ecef; --accent:#f9a825;
}
*{box-sizing:border-box}
body{margin:0; font-family:"Prompt","Sarabun","Noto Sans Thai",sans-serif; background:var(--bg); color:var(--ink)}
.wrap{max-width:1024px; margin:auto; padding:20px}
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow)}
.hd{display:flex; align-items:center; gap:12px; padding:20px; border-bottom:1px solid var(--line); font-weight:700; font-size:20px}
.hd .icon{font-size:28px}
.bd{padding:20px}

/* ‡∏ü‡∏≠‡∏£‡πå‡∏° */
.row{display:grid; grid-template-columns:1fr 1fr; gap:18px}
.row-1{display:grid; grid-template-columns:1fr; gap:18px}
label{display:block; font-size:14px; color:var(--muted); margin-bottom:8px}
input[type="text"], input[type="tel"], input[type="file"], select{
  width:100%; padding:12px 16px; border:1px solid var(--line); border-radius:8px; outline:none; background:#fff; font-size:16px;
}
input:focus, select:focus{border-color:var(--brand); box-shadow:0 0 0 3px var(--ring)}
.btns{display:flex; gap:12px; flex-wrap:wrap}
button{padding:12px 18px; border-radius:8px; border:1px solid var(--line); background:#fff; cursor:pointer; font-size:16px; font-weight:600}
.primary{background:var(--brand); color:#fff; border-color:var(--brand)}
.primary:hover{background:var(--brand-2); border-color:var(--brand-2)}
.ok{color:var(--ok)}
.accent{background:var(--accent); color:var(--ink); border-color:var(--accent)}
.accent:hover{filter:brightness(0.9)}

/* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ */
.btn-ghost-danger{background:#fff; color:var(--danger); border:1px solid var(--danger)}
.btn-ghost-danger:hover{background:#fff; filter:brightness(0.98)}

/* ‡∏•‡∏¥‡∏™‡∏ï‡πå */
.list{margin-top:20px}
.list-head{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; color:var(--muted); font-size:14px}
.item{display:grid; grid-template-columns: 1fr auto; gap:16px; align-items:center; padding:16px; border-top:1px dashed var(--line")}
.item h4{margin:0 0 6px 0; font-size:20px; font-weight:700}
.meta{display:flex; flex-wrap:wrap; gap:8px; margin-top:6px}
.chip{background:var(--chip); border:1px solid var(--line); padding:4px 10px; border-radius:999px; font-size:13px; font-weight:400}
.imgs{display:flex; gap:8px}
.thumb{width:64px; height:64px; object-fit:cover; border-radius:8px; border:1px solid var(--line)}
.muted{color:var(--muted)}

/* Side View */
.sideview{position:fixed; inset:0; display:none; z-index:50}
.sideview.show{display:block}
.sideview .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.5)}
.sideview .panel{
  position:absolute; top:0; right:0; height:100%; width:min(480px, 95vw);
  background:#fff; border-left:1px solid var(--line); box-shadow:-8px 0 24px -16px rgba(2,8,23,.35);
  display:flex; flex-direction:column; transform:translateX(100%); transition:transform .28s ease;
}
.sideview.show .panel{transform:translateX(0)}
.side-hd{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px; border-bottom:1px solid var(--line)}
.side-bd{padding:16px; overflow:auto}
.bigimgs{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px}
.bigimgs img{width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:10px; border:1px solid var(--line)}
.side-row{display:grid; grid-template-columns:140px 1fr; gap:10px; padding:10px 0; border-bottom:1px dashed var(--line)}
.side-row b{color:#555}
.side-actions{display:flex; gap:10px; padding:16px; border-top:1px solid var(--line)}
.linklike{background:#fff; border-color:var(--brand); color:var(--brand)}

/* Accordion */
details.ac{border:1px solid var(--line); border-radius:12px; background:#fff; overflow:hidden}
details.ac + details.ac{margin-top:16px}
details.ac[open] .ac-body{animation:fade .15s ease}
summary.ac-hd{
  list-style:none; cursor:pointer; padding:16px; font-weight:700; display:flex; align-items:center; gap:10px;
  background:linear-gradient(180deg,#fefefe,#fcfcfc);
  border-bottom:1px solid var(--line); font-size:18px;
}
summary.ac-hd::-webkit-details-marker{display:none}
.ac-body{padding:16px}
.caret{margin-left:auto; transition:transform .2s ease}
details[open] .caret{transform:rotate(90deg)}
@keyframes fade{from{opacity:0; transform:translateY(-2px)} to{opacity:1; transform:translateY(0)}}

/* ===== FILTER BAR ===== */
.filter-bar{display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:16px; align-items:end; margin-bottom:12px}
.filter-actions{display:flex; gap:10px}
.active-filters{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
.pill{display:inline-flex; align-items:center; gap:8px; padding:5px 12px; border-radius:999px; background:#fff; border:1px solid var(--line); font-size:13px}
.pill button{border:none; background:transparent; cursor:pointer; padding:0 4px}

/* ===== Mobile tweaks ===== */
@media (max-width:720px){
  .wrap{padding:16px}
  .hd{padding:16px; font-size:18px}
  .bd{padding:16px}
  summary.ac-hd{padding:12px 14px; font-size:16px}
  .ac-body{padding:14px}
  .row{grid-template-columns:1fr; gap:12px}
  .filter-bar{grid-template-columns: 1fr; gap:10px}
  label{font-size:12px}
  input[type="text"], input[type="tel"], input[type="file"], select{padding:10px 12px; font-size:14px}
  button{padding:10px 14px; border-radius:6px; font-size:14px}
  .item{grid-template-columns:1fr; gap:12px; padding:12px}
  .item h4{font-size:18px}
  .chip{font-size:12px; padding:3px 8px}
  .thumb{width:56px; height:56px}
}
@media (max-width:400px){
  .hd{font-size:16px}
  input[type="text"], input[type="tel"], input[type="file"], select{font-size:13px}
  button{font-size:13px}
  .item h4{font-size:16px}
}

/* ===== Confirm Modal ===== */
.confirm-backdrop{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,.5); z-index:9999; padding:16px;
}
.confirm-backdrop.show{display:flex}
.confirm-box{
  width:min(92vw, 380px); background:#fff; border:1px solid var(--line); border-radius:12px;
  box-shadow:var(--shadow); padding:20px;
}
.confirm-title{font-weight:700; margin:0 0 8px 0; font-size:20px}
.confirm-text{margin:0 0 16px 0; color:var(--muted)}
.confirm-actions{display:flex; gap:10px; justify-content:flex-end}
.btn-danger{background:#fff; color:var(--danger); border-color:var(--danger)}
.btn-danger:hover{filter:brightness(.98)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="hd"><span class="icon">üèóÔ∏è</span> ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‚Äì‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á</div>
    <div class="bd">
      <details class="ac" open>
        <summary class="ac-hd">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á <span class="caret">‚ñ∂</span></summary>
        <div class="ac-body">
          <div class="filter-bar">
            <div>
              <label for="provinceSelect">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
              <select id="provinceSelect">
                <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Äî</option>
              </select>
            </div>
            <div>
              <label for="placeInput">‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô/‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô</label>
              <input id="placeInput" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£">
            </div>
            <div>
              <label for="shipInput">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (‡∏Ñ‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)</label>
              <input id="shipInput" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á 50 ‡∏Å‡∏°. / ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á">
            </div>
            <div class="filter-actions">
              <button id="btnApply" class="accent">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
              <button id="btnClear">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
            </div>
          </div>
          <div id="activeFilters" class="active-filters"></div>
        </div>
      </details>
      
      <details class="ac" id="ac-create">
        <summary class="ac-hd">‚ûï ‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç <span class="caret">‚ñ∂</span></summary>
        <div class="ac-body">
          <div class="row">
            <div>
              <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
              <input id="ownerName" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á"/>
            </div>
            <div>
              <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏ô‡∏±‡∏î</label>
              <input id="dogName" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß"/>
            </div>
            <div>
              <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
              <input id="phone" type="tel" placeholder="081-234-5678"/>
            </div>
            <div>
              <label>‡∏ó‡∏±‡∏Å‡∏©‡∏∞/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ</label>
              <input id="reward" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡πà‡∏≤‡∏á‡∏õ‡∏π‡∏ô ‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏µ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÄ‡∏´‡∏•‡πá‡∏Å"/> 
            </div>
            <div>
              <label>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
              <input id="lastSeen" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏à‡∏î‡∏µ"/>
            </div>
            <div>
              <label>‡∏£‡∏´‡∏±‡∏™ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</label>
              <input id="id" type="text" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ"/>
            </div>
          </div>
          <div class="row" style="margin-top:16px">
            <div>
              <label>‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 1 (‡∏ú‡∏•‡∏á‡∏≤‡∏ô/‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô)</label>
              <input id="image1" type="file" accept="image/*"/>
            </div>
            <div>
              <label>‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 2</label>
              <input id="image2" type="file" accept="image/*"/>
            </div>
            <div>
              <label>‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 3</label>
              <input id="image3" type="file" accept="image/*"/>
            </div>
          </div>
          <div class="btns" style="margin-top:20px">
            <button class="primary" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          </div>
          <div id="msg" style="margin-top:12px" class="muted"></div>
        </div>
      </details>
      
      <div class="list-head">
        <div id="countText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>
        <div></div>
      </div>
      
      <div class="list" id="list"></div>

      <!-- Pagination -->
      <div id="pager" class="list-head" style="justify-content:center; gap:12px; margin-top:16px">
        <button id="btnPrev" disabled>¬´ ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
        <span id="pageInfo" class="muted">‡∏´‡∏ô‡πâ‡∏≤ 1/1</span>
        <button id="btnNext" disabled>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ¬ª</button>
      </div>
    </div>
  </div>
</div>

<!-- Side View -->
<div id="sideview" class="sideview" aria-hidden="true">
  <div class="backdrop" onclick="closeSide()"></div>
  <div class="panel" role="dialog" aria-modal="true">
    <div class="side-hd">
      <div style="display:flex;align-items:center;gap:8px">
        <span>üèóÔ∏è</span><b id="svTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</b>
      </div>
      <button onclick="closeSide()">‚úñÔ∏è ‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="side-bd">
      <div class="bigimgs" id="svImgs"></div>
      <div class="side-row"><b>‡∏£‡∏´‡∏±‡∏™</b><div id="svId">-</div></div>
      <div class="side-row"><b>‡∏•‡∏≥‡∏î‡∏±‡∏ö (index)</b><div id="svIndex">-</div></div>
      <div class="side-row"><b>‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</b><div id="svOwner">-</div></div>
      <div class="side-row"><b>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</b><div id="svName">-</div></div>
      <div class="side-row"><b>‡∏ó‡∏±‡∏Å‡∏©‡∏∞/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ</b><div id="svSkills">-</div></div>
      <div class="side-row"><b>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</b><div id="svPhone">-</div></div>
      <div class="side-row"><b>‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</b><div id="svArea">-</div></div>
      <div class="side-row"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</b><div id="svCreated">-</div></div>
      <div class="side-row"><b>‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°</b><div id="svViews">0</div></div>
    </div>
    <div class="side-actions">
      <button class="linklike" id="svFill">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      <button class="primary" id="svCall">‡πÇ‡∏ó‡∏£ / ‡πÅ‡∏ä‡∏ó</button>
    </div>
  </div>
</div>

<!-- Confirm -->
<div id="confirmBackdrop" class="confirm-backdrop" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
  <div class="confirm-box">
    <h3 id="confirmTitle" class="confirm-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ?</h3>
    <p class="confirm-text">‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
    <div class="confirm-actions">
      <button id="confirmCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button id="confirmOk" class="btn-danger">üóëÔ∏è ‡∏•‡∏ö‡πÄ‡∏•‡∏¢</button>
    </div>
  </div>
</div>

<script>
  /* ====== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á Web App (Apps Script) ======
     - ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏î‡πâ‡∏ß‡∏¢ ?api=<WEB_APP_URL> ‡∏à‡∏∞‡∏à‡∏≥‡πÉ‡∏ô localStorage.gas_api
     - ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ DEFAULT_WEB_APP_URL ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
  */
  const DEFAULT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbztNgxBLyU5T2SJrItU7_t6uOGcUJ5rVJJCM5UIJsnvf9RRfpIhtjeKgSAfvFdUYlsHSg/exec';
  const urlParams = new URLSearchParams(location.search);
  const paramApi  = urlParams.get('api');
  if (paramApi) try { localStorage.setItem('gas_api', paramApi); } catch(e) {}
  const WEB_APP_URL = (()=>{ try{ return localStorage.getItem('gas_api') || DEFAULT_WEB_APP_URL; }catch(e){ return DEFAULT_WEB_APP_URL; } })();

  /* ===== Utilities ===== */
  function setMsg(text, ok=false){
    const el = document.getElementById('msg');
    if(!el) return;
    el.textContent = text || '';
    el.className = ok ? 'ok' : 'muted';
  }
  function esc(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) }
  function scrollToForm(){ const ac=document.getElementById('ac-create'); if(ac && !ac.open) ac.open=true; ac?.scrollIntoView({behavior:'smooth', block:'start'}); }
  const norm = s => (s??'').toString().toLowerCase().normalize('NFKC').trim();

  /* ===== Provinces (77) ===== */
  const PROVINCES = ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£","‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà","‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ","‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå","‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£","‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô","‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ","‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤","‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ","‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó","‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥","‡∏ä‡∏∏‡∏°‡∏û‡∏£","‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢","‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà","‡∏ï‡∏£‡∏±‡∏á","‡∏ï‡∏£‡∏≤‡∏î","‡∏ï‡∏≤‡∏Å","‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å","‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°","‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°","‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤","‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä","‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå","‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ","‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™","‡∏ô‡πà‡∏≤‡∏ô","‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨","‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå","‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ","‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå","‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ","‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ","‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤","‡∏û‡∏±‡∏á‡∏á‡∏≤","‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á","‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£","‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å","‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ","‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå","‡πÅ‡∏û‡∏£‡πà","‡∏û‡∏∞‡πÄ‡∏¢‡∏≤","‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï","‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°","‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£","‡∏¢‡∏∞‡∏•‡∏≤","‡∏¢‡πÇ‡∏™‡∏ò‡∏£","‡∏£‡∏∞‡∏ô‡∏≠‡∏á","‡∏£‡∏∞‡∏¢‡∏≠‡∏á","‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ","‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ","‡∏•‡∏≥‡∏õ‡∏≤‡∏á","‡∏•‡∏≥‡∏û‡∏π‡∏ô","‡πÄ‡∏•‡∏¢","‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©","‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£","‡∏™‡∏á‡∏Ç‡∏•‡∏≤","‡∏™‡∏ï‡∏π‡∏•","‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£","‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°","‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£","‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß","‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ","‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ","‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢","‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ","‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ","‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå","‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢","‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π","‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á","‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç","‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ","‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå","‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ","‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ"];

  /* ====== FILTERS & DATA STATE ====== */
  let ALL_ROWS = [];
  let VIEW_ROWS = [];
  const filters = { province:"", place:"", ship:"" };

  /* ====== PAGINATION STATE ====== */
  let PAGE_SIZE = 5;   // ‡πÇ‡∏ä‡∏ß‡πå 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏´‡∏ô‡πâ‡∏≤
  let CUR_PAGE  = 1;   // ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

  function populateProvinces(){
    const sel = document.getElementById('provinceSelect');
    PROVINCES.forEach(p=>{
      const o = document.createElement('option'); o.value=p; o.textContent=p; sel.appendChild(o);
    });
  }

  function guessProvinceFromText(txt=""){
    const t = norm(txt);
    const nick = { "‡∏Å‡∏ó‡∏°":"‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£","‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û":"‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£","‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä":"‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤","‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤":"‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤" };
    for(const [k,v] of Object.entries(nick)){ if(t.includes(norm(k))) return v; }
    for(const p of PROVINCES){ if(t.includes(norm(p))) return p; }
    return "";
  }

  function buildActiveFilterPills(){
    const wrap = document.getElementById('activeFilters');
    const pills = [];
    if(filters.province) pills.push({key:'province', label:`‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ${filters.province}`});
    if(filters.place)    pills.push({key:'place',    label:`‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô: ${filters.place}`});
    if(filters.ship)     pills.push({key:'ship',     label:`‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á: ${filters.ship}`});
    wrap.innerHTML = pills.map(p=>`<span class="pill">${esc(p.label)} <button aria-label="‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á" onclick="removeFilter('${p.key}')">‚úï</button></span>`).join('');
  }

  function removeFilter(key){
    if(key==='province') document.getElementById('provinceSelect').value = '';
    if(key==='place')    document.getElementById('placeInput').value = '';
    if(key==='ship')     document.getElementById('shipInput').value = '';
    applyFilters();
  }

  function applyFilters(){
    filters.province = document.getElementById('provinceSelect').value || "";
    filters.place    = document.getElementById('placeInput').value || "";
    filters.ship     = document.getElementById('shipInput').value || "";

    const pq = norm(filters.place);
    const sq = norm(filters.ship);
    const province = filters.province;

    VIEW_ROWS = ALL_ROWS.filter(r=>{
      const area  = norm(r.lastSeen||"");
      const name  = norm(r.dogName||"");
      const owner = norm(r.ownerName||"");

      const rowProvince = r._province || guessProvinceFromText(r.lastSeen||"");

      const okProvince = province ? (rowProvince===province) : true;
      const okPlace    = pq ? (area.includes(pq) || name.includes(pq) || owner.includes(pq)) : true;
      const okShip     = sq ? area.includes(sq) : true;

      return okProvince && okPlace && okShip;
    });

    CUR_PAGE = 1;
    buildActiveFilterPills();
    renderList(VIEW_ROWS);
  }

  /* ===== Backend I/O ===== */
  const MAX_MB = 8;

  function fileToBase64(file){
    return new Promise((resolve, reject)=>{
      if(!file) return resolve('');
      const reader = new FileReader();
      reader.onload = () => {
        const res = String(reader.result || '');
        resolve(res.includes(',') ? res.split(',').pop() : res);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // Simple request: ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà headers/mode/credentials ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏î preflight
  async function postForm(params){
    const body = new URLSearchParams(params);
    let res, text;
    try{
      res = await fetch(WEB_APP_URL, { method: 'POST', body });
      text = await res.text();
    }catch(networkErr){
      console.error('NETWORK ERROR:', networkErr);
      throw new Error('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + networkErr.message);
    }
    if(!res.ok){
      console.error('HTTP ERROR:', res.status, res.statusText, text);
      throw new Error('HTTP '+res.status+' '+res.statusText+' : '+ text.slice(0,300));
    }
    try{
      const j = JSON.parse(text);
      // console.log('API RESP:', j);
      return j;
    }catch(parseErr){
      console.error('PARSE ERROR:', parseErr, text);
      throw new Error('‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON: ' + text.slice(0,300));
    }
  }

  // ===== View counter helpers =====
  function viewedKey(id){ return `viewed:${id}`; }
  function hasViewed(id){ try{ return !!localStorage.getItem(viewedKey(id)); }catch(e){ return false; } }
  function markViewed(id){ try{ localStorage.setItem(viewedKey(id), String(Date.now())); }catch(e){} }
  async function incView(id){
    try{
      const data = await postForm({ action:'incview', id }); // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å
      if(data?.ok) return Number(data.views ?? data.viewCount ?? 0);
    }catch(e){}
    return null;
  }

  /* ===== Pagination helpers ===== */
  function getTotalPages(rows){ const n = rows?.length || 0; return Math.max(1, Math.ceil(n / PAGE_SIZE)); }
  function clampPage(rows){ const totalPages = getTotalPages(rows); if(CUR_PAGE > totalPages) CUR_PAGE = totalPages; if(CUR_PAGE < 1) CUR_PAGE = 1; }
  function sliceByPage(rows){ clampPage(rows); const start = (CUR_PAGE - 1) * PAGE_SIZE; return rows.slice(start, start + PAGE_SIZE); }
  function renderPager(rows){
    const totalPages = getTotalPages(rows);
    const pageInfo = document.getElementById('pageInfo');
    const btnPrev  = document.getElementById('btnPrev');
    const btnNext  = document.getElementById('btnNext');

    if(pageInfo) pageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${CUR_PAGE.toLocaleString()}/${totalPages.toLocaleString()}`;

    if(btnPrev){ btnPrev.disabled = (CUR_PAGE <= 1); btnPrev.onclick = ()=>{ if(CUR_PAGE > 1){ CUR_PAGE--; renderList(VIEW_ROWS); } }; }
    if(btnNext){ btnNext.disabled = (CUR_PAGE >= totalPages); btnNext.onclick = ()=>{ if(CUR_PAGE < totalPages){ CUR_PAGE++; renderList(VIEW_ROWS); } }; }

    const count = document.getElementById('countText');
    if(count){
      const total = rows?.length || 0;
      const showing = sliceByPage(rows).length;
      const startNo = total ? ( (CUR_PAGE - 1) * PAGE_SIZE + 1 ) : 0;
      const endNo   = total ? ( (CUR_PAGE - 1) * PAGE_SIZE + showing ) : 0;
      count.textContent = total ? `‡πÅ‡∏™‡∏î‡∏á ${startNo.toLocaleString()}‚Äì${endNo.toLocaleString()} ‡∏à‡∏≤‡∏Å ${total.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
    }
  }

  /* ===== Render ===== */
  function renderList(rows){
    const list  = document.getElementById('list');

    clampPage(rows);
    const pageRows = sliceByPage(rows);
    renderPager(rows);

    if(!pageRows || !pageRows.length){
      list.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</div>';
      return;
    }

    list.innerHTML = pageRows.map(r=>{
      const imgs = [r.image1Url, r.image2Url, r.image3Url].filter(Boolean);
      const thumbs = imgs.map(u=>`<img class="thumb" src="${esc(u)}" alt="">`).join('');
      const rjson = esc(JSON.stringify(r));
      const rowProv = r._province || guessProvinceFromText(r.lastSeen||"") || '-';
      const views = Number(r.views ?? r.viewCount ?? 0);
      const idx = Number(r.index || 0);

      return `
        <div class="item">
          <div onclick='openSide(JSON.parse(this.dataset.r))' data-r='${rjson}' style="cursor:pointer">
            <h4>üèóÔ∏è #${idx || '-'} ‚Äî ${esc(r.dogName || '(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)')}</h4>
            <div class="meta">
              <span class="chip">‡∏ó‡∏±‡∏Å‡∏©‡∏∞: ${esc(r.reward || '-')}</span>
              <span class="chip">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: ${esc(rowProv)}</span>
              <span class="chip">‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${esc(r.lastSeen || '-')}</span>
              <span class="chip">‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${esc(r.ownerName || '-')}</span>
            </div>
            <div class="imgs" style="margin-top:8px">${thumbs || ''}</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <button onclick='openSide(JSON.parse(this.dataset.r))' data-r='${rjson}'>üëÅÔ∏è ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
            <button onclick='fillForm(JSON.parse(this.dataset.r)); scrollToForm();' data-r='${rjson}'>‚úçÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <span class="muted" title="‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">üëÅÔ∏è ${views.toLocaleString()}</span>
            <button class="btn-ghost-danger" onclick='handleDelete(JSON.parse(this.dataset.r))' data-r='${rjson}'>üóëÔ∏è ‡∏•‡∏ö‡πÇ‡∏û‡∏™</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function fillForm(r){
    document.getElementById('id').value = r.id || '';
    document.getElementById('ownerName').value = r.ownerName || '';
    document.getElementById('dogName').value = r.dogName || '';
    document.getElementById('phone').value = r.phone || '';
    document.getElementById('reward').value = r.reward || '';
    document.getElementById('lastSeen').value = r.lastSeen || '';
    scrollToForm();
    setMsg('‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)', true);
  }

  async function openSide(r){
    const sv = document.getElementById('sideview');
    document.getElementById('svTitle').textContent  = r.dogName || '(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)';
    document.getElementById('svId').textContent     = r.id || '-';
    document.getElementById('svIndex').textContent  = (r.index || '-');
    document.getElementById('svOwner').textContent  = r.ownerName || '-';
    document.getElementById('svName').textContent   = r.dogName || '-';
    document.getElementById('svSkills').textContent = r.reward || '-';
    document.getElementById('svPhone').textContent  = r.phone || '-';
    document.getElementById('svArea').textContent   = r.lastSeen || '-';
    document.getElementById('svCreated').textContent= r.createdAt || '-';
    document.getElementById('svViews').textContent  = Number(r.views ?? r.viewCount ?? 0).toLocaleString();

    const imgs = [r.image1Url, r.image2Url, r.image3Url].filter(Boolean);
    document.getElementById('svImgs').innerHTML = imgs.length
      ? imgs.map(u=>`<img src="${esc(u)}" alt="">`).join('')
      : '<div class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ô‡∏ö</div>';

    document.getElementById('svFill').onclick = ()=>{ fillForm(r); closeSide(); };
    document.getElementById('svCall').onclick = ()=>{ if(r.phone){ window.location.href = `tel:${r.phone}`; } else alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠'); };

    sv.classList.add('show');
    sv.setAttribute('aria-hidden','false');

    if(r.id && !hasViewed(r.id)){
      const newViews = await incView(r.id);
      if(newViews !== null){
        r.views = newViews;
        document.getElementById('svViews').textContent = newViews.toLocaleString();
        const idx1 = ALL_ROWS.findIndex(x => String(x.id) === String(r.id));
        if(idx1 > -1) ALL_ROWS[idx1].views = newViews;
        const idx2 = VIEW_ROWS.findIndex(x => String(x.id) === String(r.id));
        if(idx2 > -1) VIEW_ROWS[idx2].views = newViews;
        renderList(VIEW_ROWS);
        markViewed(r.id);
      }
    }
  }
  function closeSide(){
    const sv = document.getElementById('sideview');
    sv.classList.remove('show');
    sv.setAttribute('aria-hidden','true');
  }

  /* ===== Load list & enrich rows ===== */
  async function handleList(){
    setMsg('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Ä¶');
    try{
      const data = await postForm({action:'list'});
      if(!data.ok) throw new Error(data.error || 'list error');
      ALL_ROWS = (data.rows || []).map(r => ({...r, _province: guessProvinceFromText(r.lastSeen||"")}));
      VIEW_ROWS = [...ALL_ROWS];
      CUR_PAGE = 1;
      setMsg('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true);
      renderList(VIEW_ROWS);
    }catch(err){
      setMsg('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+err.message);
    }
  }

  /* ===== Confirm Modal utilities ===== */
  function showConfirm(onYes, opts={}){
    const backdrop  = document.getElementById('confirmBackdrop');
    const btnOk     = document.getElementById('confirmOk');
    const btnCancel = document.getElementById('confirmCancel');
    const title     = document.getElementById('confirmTitle');

    if(opts.title) title.textContent = String(opts.title);
    backdrop.classList.add('show');

    const close   = ()=>backdrop.classList.remove('show');
    const onOk    = ()=>{ cleanup(); close(); onYes && onYes(); };
    const onCancel= ()=>{ cleanup(); close(); };
    const onKey   = (e)=>{ if(e.key==='Escape') onCancel(); if(e.key==='Enter') onOk(); };
    const onClickBackdrop = (e)=>{ if(e.target === backdrop) onCancel(); };

    function cleanup(){
      btnOk.removeEventListener('click', onOk);
      btnCancel.removeEventListener('click', onCancel);
      window.removeEventListener('keydown', onKey);
      backdrop.removeEventListener('click', onClickBackdrop);
    }

    btnOk.addEventListener('click', onOk);
    btnCancel.addEventListener('click', onCancel);
    window.addEventListener('keydown', onKey);
    backdrop.addEventListener('click', onClickBackdrop);
  }

  /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ id => update, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ => create ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
  document.getElementById('btnSave').addEventListener('click', async ()=>{
    try{
      setMsg('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶');

      const id        = document.getElementById('id').value.trim();
      const ownerName = document.getElementById('ownerName').value.trim();
      const dogName   = document.getElementById('dogName').value.trim();
      const phone     = document.getElementById('phone').value.trim();
      const reward    = document.getElementById('reward').value.trim();
      const lastSeen  = document.getElementById('lastSeen').value.trim();

      const f1 = document.getElementById('image1').files[0] || null;
      const f2 = document.getElementById('image2').files[0] || null;
      const f3 = document.getElementById('image3').files[0] || null;

      const MAX_MB = 8;
      for (const f of [f1,f2,f3].filter(Boolean)) {
        if (f.size > MAX_MB*1024*1024) {
          setMsg(`‡πÑ‡∏ü‡∏•‡πå ${f.name} ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${MAX_MB}MB ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô`, false);
          return;
        }
      }

      const [b1,b2,b3] = await Promise.all([fileToBase64(f1), fileToBase64(f2), fileToBase64(f3)]);

      if(id){
        const p = { action:'update', id, ownerName, dogName, phone, reward, lastSeen };
        if(f1){ p.image1 = b1; p.image1_type = f1.type; p.image1_name = f1.name; }
        if(f2){ p.image2 = b2; p.image2_type = f2.type; p.image2_name = f2.name; }
        if(f3){ p.image3 = b3; p.image3_type = f3.type; p.image3_name = f3.name; }
        const data = await postForm(p);
        if(!data.ok) throw new Error(data.error || 'update error');
        setMsg('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true);
      }else{
        const params = {
          action: 'create',
          ownerName, dogName, phone, reward, lastSeen,
          image1: b1, image1_type: f1 ? f1.type : '', image1_name: f1 ? f1.name : '',
          image2: b2, image2_type: f2 ? f2.type : '', image2_name: f2 ? f2.name : '',
          image3: b3, image3_type: f3 ? f3.type : '', image3_name: f3 ? f3.name : ''
        };
        const data = await postForm(params);
        if(!data.ok) throw new Error(data.error || 'create error');
        setMsg('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+ (data.row && data.row.id ? data.row.id : ''), true);
        ['image1','image2','image3'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      }

      await handleList();
      const ac = document.getElementById('ac-create'); if(ac) ac.open = false;
    }catch(err){
      setMsg('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+err.message);
    }
  });

  /* ‡∏•‡∏ö‡πÇ‡∏û‡∏™ ‚Äî ‚úÖ ‡∏Ç‡∏≠ Token ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠ */
  function handleDelete(r){
    if(!r?.id) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™');

    showConfirm(async ()=>{
      try{
        const token = prompt('‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà Token ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ:') || '';
        setMsg('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‚Ä¶');
        const data = await postForm({
          action:'delete',
          id: r.id,
          token,                 // ‚òÖ ‡∏™‡πà‡∏á token
          deleteImages:'1',
          image1Url: r.image1Url || '',
          image2Url: r.image2Url || '',
          image3Url: r.image3Url || ''
        });
        if(!data.ok) throw new Error(data.error || 'delete error');
        setMsg('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true);
        await handleList();
        const sv = document.getElementById('sideview');
        if(sv?.classList.contains('show')) closeSide();
      }catch(err){
        setMsg('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+err.message);
        alert('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message);
      }
    }, { title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ?' });
  }

  /* Filter wiring */
  document.getElementById('btnApply').addEventListener('click', applyFilters);
  document.getElementById('btnClear').addEventListener('click', ()=>{
    document.getElementById('provinceSelect').value='';
    document.getElementById('placeInput').value='';
    document.getElementById('shipInput').value='';
    applyFilters();
  });
  document.getElementById('placeInput').addEventListener('keydown', e=>{ if(e.key==='Enter') applyFilters(); });
  document.getElementById('shipInput').addEventListener('keydown', e=>{ if(e.key==='Enter') applyFilters(); });

  /* ===== Quick API ping ===== */
  (async ()=>{
    try{
      const ping = await postForm({action:'ping'});
      if(ping?.ok){ setMsg('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API', true); }
    }catch(e){
      setMsg('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏¢‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ('+ e.message +')');
    }
  })();

  /* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
  populateProvinces();
  handleList();

  /* ‡∏õ‡∏¥‡∏î SideView ‡∏î‡πâ‡∏ß‡∏¢ ESC */
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSide(); });
</script>
</body>
</html>
