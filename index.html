<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ/‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° ‚Äì ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏°‡∏ä‡∏±‡∏î + Google Sign-In</title>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
  :root{
    --bg:#f8fafc; --paper:#ffffff; --ink:#111827; --muted:#6b7280;
    --brand:#2563eb; --line:#e5e7eb; --line-dark:#d1d5db;
    --radius:10px; --ctl-h:32px; --fs:14px; --fs-sm:12.5px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Sarabun",system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai",Arial,sans-serif;font-size:var(--fs);line-height:1.55}

  header{position:sticky;top:0;z-index:50;background:var(--paper);border-bottom:1px solid var(--line)}
  .wrap{max-width:1040px;margin:auto;padding:10px 12px}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;min-height:44px}
  .search{flex:1;display:flex;gap:6px;align-items:center}
  input[type="search"], select{
    height:var(--ctl-h); padding:0 10px; border:1px solid var(--line); border-radius:8px; background:#fafafa; font-size:13.5px;
  }
  input:focus,select:focus{outline:none;border-color:#93c5fd;box-shadow:0 0 0 2px #bfdbfe}
  button{height:var(--ctl-h); padding:0 12px; border:0; border-radius:8px; background:var(--brand); color:#fff; font-weight:700; font-size:13.5px; cursor:pointer}
  button.ghost{background:#e9eefb; color:#1e3a8a}
  button.danger{background:#ef4444}
  button[disabled]{opacity:.6; cursor:not-allowed}
  .sign{display:flex;gap:6px;align-items:center}
  .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;display:none}

  .table-wrap{background:var(--paper); border:1px solid var(--line); border-radius:var(--radius); overflow:hidden;margin-top:10px}
  .scroll-x{overflow-x:auto}
  table{width:100%; border-collapse:collapse; table-layout:fixed}
  thead{background:#f3f4f6; position:sticky; top:0; z-index:10; border-bottom:1px solid var(--line-dark)}
  th, td{padding:8px 10px; border-bottom:1px solid var(--line); vertical-align:top; word-break:break-word}
  th{font-weight:700; text-align:left; font-size:13.5px; color:#374151}
  td{font-size:13.5px}
  tr:hover td{background:#f9fafb}

  .col-id{width:72px}
  .col-title{width:auto}
  .col-owner{width:180px}
  .col-latest{width:160px}
  .col-replies{width:84px; text-align:right}
  .col-views{width:84px; text-align:right}
  .title a{font-weight:700; color:#111827; text-decoration:none}
  .title a:hover{text-decoration:underline}
  .meta{font-size:var(--fs-sm); color:var(--muted); margin-top:4px}
  .chips{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px}
  .chip{border:1px solid var(--line); background:#fff; color:#111; padding:3px 8px; border-radius:999px; font-size:12px; height:24px; display:inline-flex; align-items:center}
  .chip.active{background:#e0e7ff; border-color:#a5b4fc; color:#3730a3; font-weight:600}

  .pager{display:flex;gap:6px;justify-content:center;align-items:center; padding:12px}
  #pageInfo{font-size:12.5px; background:#eef2ff; color:#1e40af; padding:6px 10px; border-radius:8px}

  @media (max-width:720px){
    .col-owner,.col-views{display:none}
    .col-id{width:60px}
    th,td{padding:7px 8px; font-size:13px}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="toolbar">
      <div class="search">
        <input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‚Ä¶"/>
        <select id="catFilter"><option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option></select>
        <button class="ghost" id="btnSearch" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="sign">
        <img id="avatar" class="avatar" alt="">
        <div id="signin"></div><!-- ‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° Google -->
        <button id="btnSignOut" class="ghost" style="display:none">‡∏≠‡∏≠‡∏Å</button>
        <button id="btnAdd" disabled>‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="table-wrap">
    <div class="scroll-x">
      <table aria-live="polite">
        <thead>
          <tr>
            <th class="col-id">‡∏£‡∏´‡∏±‡∏™</th>
            <th class="col-title">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
            <th class="col-owner">‡πÇ‡∏î‡∏¢</th>
            <th class="col-latest">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
            <th class="col-replies" title="‡∏ï‡∏≠‡∏ö">‡∏ï‡∏≠‡∏ö</th>
            <th class="col-views" title="‡∏≠‡πà‡∏≤‡∏ô">‡∏≠‡πà‡∏≤‡∏ô</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="pager">
      <button id="prev">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
      <div id="pageInfo"></div>
      <button id="next">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
    </div>
  </div>
</main>

<!-- Dialog ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
<div id="dlg" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);padding:12px;z-index:60">
  <div style="background:var(--paper);border:1px solid var(--line);border-radius:10px;max-width:520px;width:100%;padding:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h3 id="dlgTitle" style="margin:0">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
      <button id="closeDlg" class="ghost">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div style="display:grid;gap:8px;margin-top:10px">
      <input id="title" type="text" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" style="height:32px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#fafafa">
      <textarea id="body" rows="5" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô b/i/u/a/img/pre/code) ‡πÄ‡∏ä‡πà‡∏ô &lt;b&gt;‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤&lt;/b&gt;" style="padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fafafa"></textarea>
      <select id="postCategory" style="height:32px;padding:0 10px;border:1px solid var(--line);border-radius:8px;background:#fafafa"><option value="">(‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‚Ä¶)</option></select>
      <input id="file" type="file" accept="image/*">
      <button id="save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<script>
  /* ===== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ===== */
  const WEB_APP_BASE = 'https://script.google.com/macros/s/AKfycbySSYD2QpQxWsX7Len5J2k_PlFdgdqZyZV7q-TiBXXj9bkg93hfsZYCT9DBvlWi7slMJg/exec';
  const CLIENT_ID    = '986811661821-d65agv1s2rmdcq743nif06a3ek0a01b5.apps.googleusercontent.com';
  /* =================== */

  let idToken='', me=null, page=1; const pageSize=10; let editingId=null;
  const EMOJIS=['üëç','‚ù§Ô∏è','üòÇ','üëè'];

  const $=(id)=>document.getElementById(id);
  const toQS=(o)=>Object.entries(o).map(([k,v])=>encodeURIComponent(k)+'='+encodeURIComponent(v)).join('&');
  const showError=(t,m)=>Swal.fire({icon:'error',title:t,text:m||''});
  const showSuccess=(t)=>Swal.fire({icon:'success',title:t,showConfirmButton:false,timer:1200});

  function setSignedInUI(on){
    const avatar=$('avatar'), signin=$('signin'), btnAdd=$('btnAdd'), btnSignOut=$('btnSignOut');
    if(on){
      signin.style.display='none'; btnSignOut.style.display='inline-block'; btnAdd.disabled=false;
      avatar.style.display = me && me.picture ? 'block' : 'none';
      if(me && me.picture) avatar.src = me.picture;
    }else{
      signin.style.display='block'; btnSignOut.style.display='none'; btnAdd.disabled=true; avatar.style.display='none';
    }
  }

  // Google Sign-In
  window.onload = async () => {
    try{
      const savedToken=localStorage.getItem('idToken');
      const savedMe=localStorage.getItem('me');
      if(savedToken) idToken=savedToken;
      if(savedMe) me=JSON.parse(savedMe);
      setSignedInUI(!!(idToken && me && me.email));
    }catch(e){}

    const initGIS = () => {
      google.accounts.id.initialize({ client_id: CLIENT_ID, callback: handleCredentialResponse, auto_select:false });
      google.accounts.id.renderButton($('signin'), { theme:"outline", size:"medium", text:"signin_with", locale:"th" });
    };
    if(window.google?.accounts?.id){ initGIS(); }
    else {
      const iv=setInterval(()=>{ if(window.google?.accounts?.id){ clearInterval(iv); initGIS(); } },120);
    }

    await loadCategoriesToUI();
    if(idToken){ try{ await fetchMe(); setSignedInUI(!!(me && me.email)); }catch(e){} }
    if(me && me.email) loadList();
  };

  async function handleCredentialResponse(resp){
    if(!resp || !resp.credential){ showError('Sign in ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡πÑ‡∏°‡πà‡∏û‡∏ö credential'); return; }
    idToken=resp.credential;
    await fetchMe();
    if(me && me.email){
      localStorage.setItem('idToken', idToken);
      localStorage.setItem('me', JSON.stringify(me));
      setSignedInUI(true); showSuccess('‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); loadList();
    }else{ setSignedInUI(false); showError('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'); }
  }

  $('btnSignOut').addEventListener('click', ()=>{
    try{ google.accounts.id.disableAutoSelect(); }catch(e){}
    idToken=''; me=null; localStorage.removeItem('idToken'); localStorage.removeItem('me');
    setSignedInUI(false); $('tbody').innerHTML=''; $('pageInfo').textContent='';
  });

  // Data
  async function fetchMe(){
    const r=await fetch(WEB_APP_BASE+'?'+toQS({action:'me', idToken}));
    const j=await r.json().catch(()=>null);
    if(!r.ok || (j && j.error)){ me=null; return; }
    me=j||null;
  }

  async function loadCategoriesToUI(){
    try{
      const r=await fetch(WEB_APP_BASE+'?action=categories');
      const j=await r.json();
      const filterSel=$('catFilter'); filterSel.innerHTML='<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>';
      j.categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; filterSel.appendChild(o); });
      filterSel.addEventListener('change', ()=>{ page=1; loadList(); });

      const postSel=$('postCategory'); if(postSel){ postSel.innerHTML=''; j.categories.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; postSel.appendChild(o); }); }
    }catch(err){ showError('‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', String(err)); }
  }

  async function fetchReactions(postId){
    const r=await fetch(WEB_APP_BASE+'?'+toQS({action:'reactions', idToken, postId}));
    const j=await r.json().catch(()=>null);
    if(!r.ok || !j || j.error) throw new Error(j?JSON.stringify(j):'');
    EMOJIS.forEach(e=>{ if(typeof j.counts[e] !== 'number') j.counts[e]=0; });
    return j;
  }
  async function sendReaction(postId, emoji){
    const form=new URLSearchParams(); form.set('action','react'); form.set('idToken', idToken); form.set('postId', postId); form.set('emoji', emoji);
    const r=await fetch(WEB_APP_BASE,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:form.toString()});
    const j=await r.json().catch(()=>null);
    if(!r.ok || !j || j.error) throw new Error(j?JSON.stringify(j):'');
    EMOJIS.forEach(e=>{ if(typeof j.counts[e] !== 'number') j.counts[e]=0; });
    return j;
  }

  async function loadList(){
    if(!idToken){ showError('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ'); return; }
    const q=$('q').value.trim(); const category=$('catFilter').value||'';
    const r=await fetch(WEB_APP_BASE+'?'+toQS({action:'list', idToken, q, page, pageSize, category}));
    const j=await r.json().catch(()=>null);
    if(!r.ok || !j || j.error){ showError('‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', j?.error||''); return; }
    renderTable(j);
  }

  function renderTable(data){
    const tb=$('tbody'); tb.innerHTML='';
    (data.items||[]).forEach((item,idx)=>{
      const tr=document.createElement('tr');

      const tdId=document.createElement('td'); tdId.className='col-id'; tdId.textContent=item.id || (idx+1);
      const tdTitle=document.createElement('td'); tdTitle.className='col-title';
      const titleDiv=document.createElement('div'); titleDiv.className='title';
      const a=document.createElement('a'); a.href='view.html?id='+encodeURIComponent(item.id); a.target='_blank'; a.textContent=item.title || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)';
      titleDiv.appendChild(a);
      const meta=document.createElement('div'); meta.className='meta';
      meta.textContent=(item.category?`‡∏´‡∏°‡∏ß‡∏î: ${item.category} ‚Ä¢ `:'') + (item.ownerEmail?`‡πÇ‡∏î‡∏¢ ${item.ownerEmail}`:'');
      const chips=document.createElement('div'); chips.className='chips';
      const reacts=document.createElement('div'); reacts.style.display='flex'; reacts.style.gap='6px';
      (async()=>{ try{ const rx=await fetchReactions(item.id); renderReacts(reacts,item.id,rx);}catch(e){} })();
      chips.appendChild(reacts);
      tdTitle.appendChild(titleDiv); tdTitle.appendChild(meta); tdTitle.appendChild(chips);

      const tdOwner=document.createElement('td'); tdOwner.className='col-owner'; tdOwner.textContent=item.ownerEmail||'-';
      const tdLatest=document.createElement('td'); tdLatest.className='col-latest'; tdLatest.textContent=item.updatedAt ? new Date(item.updatedAt).toLocaleString() : (item.createdAt?new Date(item.createdAt).toLocaleString():'-');
      const tdReplies=document.createElement('td'); tdReplies.className='col-replies'; tdReplies.textContent = item.replies ?? '0';
      const tdViews=document.createElement('td'); tdViews.className='col-views'; tdViews.textContent = item.views ?? '0';

      tr.appendChild(tdId); tr.appendChild(tdTitle); tr.appendChild(tdOwner); tr.appendChild(tdLatest); tr.appendChild(tdReplies); tr.appendChild(tdViews);
      tb.appendChild(tr);
    });

    $('pageInfo').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${data.page} / ${data.totalPages} ‚Äì ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    $('prev').disabled = data.page<=1; $('next').disabled = data.page>=data.totalPages;
  }

  function renderReacts(container, postId, data){
    container.innerHTML='';
    EMOJIS.forEach(e=>{
      const b=document.createElement('button');
      b.className='chip'+(data.mine===e?' active':''); b.textContent=`${e} ${data.counts[e]||0}`;
      b.addEventListener('click', async (evt)=>{
        const row=evt.currentTarget.closest('tr'); row.querySelectorAll('.chip').forEach(c=>c.disabled=true);
        try{ const updated=await sendReaction(postId, e); renderReacts(container, postId, updated); }
        catch(err){ showError('‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', String(err)); }
        finally{ row.querySelectorAll('.chip').forEach(c=>c.disabled=false); }
      });
      container.appendChild(b);
    });
  }

  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡πÄ‡∏û‡∏à‡πÄ‡∏à‡∏≠‡∏£‡πå/‡πÑ‡∏î‡∏≠‡∏∞‡∏•‡πá‡∏≠‡∏Å
  $('btnSearch').addEventListener('click', ()=>{ page=1; loadList(); });
  $('q').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); page=1; loadList(); }});
  $('prev').addEventListener('click', ()=>{ if(page>1){ page--; loadList(); }});
  $('next').addEventListener('click', ()=>{ page++; loadList(); });

  const dlg=$('dlg'); $('btnAdd').addEventListener('click', openCreate); $('closeDlg').addEventListener('click', ()=> dlg.style.display='none');

  function openCreate(){ editingId=null; $('dlgTitle').textContent='‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; $('title').value=''; $('body').value=''; $('file').value=''; const s=$('postCategory'); if(s&&s.options.length) s.selectedIndex=0; dlg.style.display='flex'; }
  function openEdit(item){ editingId=item.id; $('dlgTitle').textContent='‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå'; $('title').value=item.title||''; $('body').value=item.body||''; $('file').value=''; const s=$('postCategory'); if(s){ const ix=[...s.options].findIndex(o=>o.value===item.category); s.selectedIndex= ix>=0?ix:0; } dlg.style.display='flex'; }

  $('save').addEventListener('click', savePost);
  async function savePost(evt){
    if(!idToken){ showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ'); return; }
    const title=$('title').value.trim(); const body=$('body').value.trim(); const file=$('file').files[0];
    const category=($('postCategory')?.value||'').trim();
    if(!title){ showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠'); return; }
    const btn=evt.target; const t=btn.textContent; btn.disabled=true; btn.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶';
    try{
      let imageData=''; if(file) imageData=await fileToDataURL(file);
      const form=new URLSearchParams(); form.set('idToken', idToken); form.set('title', title); form.set('body', body);
      if(category) form.set('category', category); if(imageData) form.set('imageData', imageData);
      if(editingId){ form.set('action','update'); form.set('id', editingId); } else { form.set('action','create'); }
      const r=await fetch(WEB_APP_BASE,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:form.toString()});
      const j=await r.json().catch(()=>null); if(!r.ok || (j && j.error)) throw new Error(j?JSON.stringify(j):'Save failed');
      dlg.style.display='none'; showSuccess('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); page=1; loadList();
    }catch(err){ showError(`${editingId?'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç':'‡∏™‡∏£‡πâ‡∏≤‡∏á'} ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, err.message); }
    finally{ btn.disabled=false; btn.textContent=t; }
  }

  function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
</script>
</body>
</html>
