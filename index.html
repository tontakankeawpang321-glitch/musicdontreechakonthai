<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>‡∏Å‡∏£‡∏∞‡∏ó‡∏π‡πâ/‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° ‚Äì ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà</title>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
  :root{
    --bg:#f8fafc; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
    --brand:#3b82f6; --paper:#ffffff; --radius:16px;
    --danger:#ef4444; --ghost:#eef2ff; --ok:#22c55e;
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:"Sarabun", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", Arial, sans-serif; line-height: 1.6;}
  header{position:sticky;top:0;z-index:10;background:var(--paper);border-bottom:1px solid var(--line); box-shadow: var(--shadow-sm);}
  .wrap{max-width:900px;margin:auto;padding:14px}
  .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .search{flex:1;display:flex;gap:8px}
  input[type="search"], select, textarea, input[type="text"] {
    flex:1; padding:10px 14px; border:1px solid var(--line); border-radius:10px; background:#fafafa; font-size:16px;
    transition: box-shadow .2s ease, border-color .2s ease;
  }
  input:focus, select:focus, textarea:focus { outline:none; border-color:var(--brand); box-shadow: 0 0 0 3px #bfdbfe; }
  
  button{border:0;border-radius:10px;padding:10px 16px;background:var(--brand);color:#fff;cursor:pointer; font-weight: 700; transition: all .2s ease;}
  button:hover:not([disabled]){transform:translateY(-1px); box-shadow:var(--shadow-md);}
  button[disabled]{opacity:.6;cursor:not-allowed}
  
  .list{display:grid;gap:14px;margin-top:14px}
  .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);padding:16px;display:grid;grid-template-columns:64px 1fr;gap:14px; box-shadow:var(--shadow-sm); transition: box-shadow .2s ease, transform .2s ease;}
  .card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
  .thumb{width:64px;height:64px;border-radius:10px;object-fit:cover;background:#eee}
  .title{font-weight:700;margin:0 0 4px 0; font-size: 1.1em;}
  .meta{font-size:13px;color:var(--muted)}
  .pager{display:flex;gap:8px;justify-content:center;margin:16px 0}
  
  .dialog-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px; z-index: 20; animation: fadeIn .3s ease;}
  .dialog{background:var(--paper);border-radius:16px;max-width:520px;width:100%;padding:24px;border:1px solid var(--line); box-shadow: var(--shadow-md); animation: slideUp .3s ease forwards; transform: translateY(20px);}

  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0.8; } to { transform: translateY(0); opacity: 1; } }

  .dialog h3{margin:0 0 16px 0}
  .grid{display:grid;gap:12px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px; align-items: center;}
  .chip{border:1px solid var(--line);background:#fff;color:#111;padding:6px 12px;border-radius:999px;font-size:13px;cursor:pointer;transition: all .2s ease;}
  .chip:hover:not([disabled]) { border-color: #9ca3af; }
  .chip.active{background:#e0e7ff;border-color:#a5b4fc; color: #3730a3; font-weight: 600;}
  .chip[disabled] { opacity: .5; cursor: not-allowed; }

  .ghost{background:var(--ghost);color:#1e40af}
  .danger{background:var(--danger)}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="toolbar">
      <div class="search">
        <input id="q" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á..." />
        <select id="catFilter">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>
        </select>
        <button class="ghost" id="btnSearch">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="sign" style="display:flex; gap:8px; align-items:center;">
        <img id="avatar" class="avatar" src="" alt="" style="display:none;width:32px;height:32px;border-radius:50%;object-fit:cover">
        <div id="signin"></div>
        <button id="btnSignOut" class="ghost" style="display:none">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å</button>
        <button id="btnAdd" disabled>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="list" class="list"></div>
  <div class="pager">
    <button id="prev">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    <div id="pageInfo" class="ghost" style="padding:10px 14px;border-radius:10px;"></div>
    <button id="next">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
  </div>
</main>

<div id="dlg" class="dialog-backdrop" role="dialog" aria-modal="true">
  <div class="dialog">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <h3 id="dlgTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
      <button id="closeDlg" class="ghost" style="background:#f3f4f6;color:#111">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="grid">
      <input id="title" type="text" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠" />
      <textarea id="body" rows="5" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea>
      <select id="postCategory"><option value="">(‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‚Ä¶)</option></select>
      <input id="file" type="file" accept="image/*" />
      <button id="save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<script>
  // ======= ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡πá‡∏Ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì =======
  const WEB_APP_BASE = 'https://script.google.com/macros/s/AKfycbySSYD2QpQxWsX7Len5J2k_PlFdgdqZyZV7q-TiBXXj9bkg93hfsZYCT9DBvlWi7slMJg/exec';
  const CLIENT_ID = '986811661821-d65agv1s2rmdcq743nif06a3ek0a01b5.apps.googleusercontent.com';
  // ===========================================

  let idToken = '';
  let me = null;
  let page = 1;
  const pageSize = 10;
  let editingId = null;

  const EMOJIS = ['üëç','‚ù§Ô∏è','üòÇ','üëè'];

  // --- MODIFIED: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ SweetAlert2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤ ---
  function toQS(obj) { return Object.entries(obj).map(([k,v])=>encodeURIComponent(k)+'='+encodeURIComponent(v)).join('&'); }
  function showError(msg, extra){
    console.error('[ERROR]', msg, extra||'');
    Swal.fire({ icon: 'error', title: msg, text: extra || '' });
  }
  function showSuccess(msg) {
    Swal.fire({ icon: 'success', title: msg, showConfirmButton: false, timer: 1500 });
  }

  function setSignedInUI(on){
    const avatar = document.getElementById('avatar');
    const signin = document.getElementById('signin');
    const btnAdd = document.getElementById('btnAdd');
    const btnSignOut = document.getElementById('btnSignOut');
    if (on) {
      signin.style.display = 'none';
      btnSignOut.style.display = 'inline-block';
      btnAdd.disabled = false;
      avatar.style.display = me && me.picture ? 'block' : 'none';
      if (me && me.picture) avatar.src = me.picture;
    } else {
      signin.style.display = 'block';
      btnSignOut.style.display = 'none';
      btnAdd.disabled = true;
      avatar.style.display = 'none';
    }
  }

  // ===== GIS =====
  window.onload = async function() {
    try {
      const savedToken = localStorage.getItem('idToken');
      const savedMe = localStorage.getItem('me');
      if (savedToken) idToken = savedToken;
      if (savedMe) me = JSON.parse(savedMe);
      if (idToken && me && me.email) setSignedInUI(true);
    } catch(e){}

    google.accounts.id.initialize({
      client_id: CLIENT_ID,
      callback: handleCredentialResponse,
      auto_select: false,
    });
    google.accounts.id.renderButton(
      document.getElementById('signin'),
      { theme: "outline", size: "large", text: "signin_with", locale: "th" }
    );
    
    await loadCategoriesToUI();
    
    if (idToken) {
      try {
        await fetchMe();
        if (me && me.email) {
          setSignedInUI(true);
          loadList();
        } else setSignedInUI(false);
      } catch(e) { setSignedInUI(false); }
    }
  };

  async function handleCredentialResponse(resp) {
    if (!resp || !resp.credential) { showError('Sign in ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÑ‡∏°‡πà‡∏û‡∏ö credential'); return; }
    idToken = resp.credential;
    await fetchMe();
    if (me && me.email) {
      localStorage.setItem('idToken', idToken);
      localStorage.setItem('me', JSON.stringify(me));
      setSignedInUI(true);
      showSuccess('‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
      loadList();
    } else {
      setSignedInUI(false);
      showError('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô');
    }
  }

  document.getElementById('btnSignOut').addEventListener('click', ()=>{
    try { google.accounts.id.disableAutoSelect(); } catch(e){}
    idToken=''; me=null;
    localStorage.removeItem('idToken'); localStorage.removeItem('me');
    setSignedInUI(false);
    document.getElementById('list').innerHTML = '';
    document.getElementById('pageInfo').textContent = '';
  });

  async function fetchMe(){
    const url = WEB_APP_BASE + '?' + toQS({ action:'me', idToken });
    const r = await fetch(url);
    const j = await r.json().catch(()=>null);
    if (!r.ok || (j && j.error)) { me=null; return; }
    me = j || null;
  }

  // ===== Categories =====
  async function loadCategoriesToUI(){
    try {
      const url = WEB_APP_BASE + '?' + toQS({ action:'categories', idToken: idToken || 'dummy' });
      const r = await fetch(url);
      const j = await r.json().catch(()=>null);
      if (!r.ok || !j || j.error) throw new Error(j ? JSON.stringify(j) : 'Cannot load categories');

      const filterSel = document.getElementById('catFilter');
      j.categories.forEach(c=>{
        const o = document.createElement('option'); o.value=c; o.textContent=c; filterSel.appendChild(o);
      });
      filterSel.addEventListener('change', ()=>{ page=1; loadList(); });

      const catSel = document.getElementById('postCategory');
      catSel.innerHTML = '';
      j.categories.forEach(c=>{
        const o = document.createElement('option'); o.value=c; o.textContent=c; catSel.appendChild(o);
      });
    } catch(err) {
      showError('‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', err.message);
    }
  }

  // ===== Reactions =====
  async function fetchReactions(postId){
    const url = WEB_APP_BASE + '?' + toQS({ action:'reactions', idToken, postId });
    const r = await fetch(url);
    const j = await r.json().catch(()=>null);
    if (!r.ok || !j || j.error) throw new Error(j?JSON.stringify(j):'');
    EMOJIS.forEach(e=>{ if(typeof j.counts[e] !== 'number') j.counts[e]=0; });
    return j;
  }
  async function sendReaction(postId, emoji){
    const form = new URLSearchParams();
    form.set('action','react'); form.set('idToken', idToken);
    form.set('postId', postId); form.set('emoji', emoji);
    const r = await fetch(WEB_APP_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form.toString() });
    const j = await r.json().catch(()=>null);
    if (!r.ok || !j || j.error) throw new Error(j?JSON.stringify(j):'');
    EMOJIS.forEach(e=>{ if(typeof j.counts[e] !== 'number') j.counts[e]=0; });
    return j;
  }
  function renderReactions(container, postId, data){
    container.innerHTML = '';
    EMOJIS.forEach(e=>{
      const b = document.createElement('button');
      b.className = 'chip' + (data.mine === e ? ' active' : '');
      b.textContent = `${e} ${data.counts[e]||0}`;
      b.addEventListener('click', async (evt)=>{
        // --- MODIFIED: ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡∏Å‡∏î reaction ---
        // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° reaction ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥
        const allChips = evt.target.closest('.actions').querySelectorAll('.chip');
        allChips.forEach(c => c.disabled = true);
        try {
          const updated = await sendReaction(postId, e);
          renderReactions(container, postId, updated);
        } catch(err){
          showError('‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', String(err));
        } finally {
          // ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏´‡∏•‡∏±‡∏á re-render)
          const newChips = evt.target.closest('.actions').querySelectorAll('.chip');
          newChips.forEach(c => c.disabled = false);
        }
      });
      container.appendChild(b);
    });
  }

  // ===== List / Render =====
  async function loadList() {
    if (!idToken) { showError('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ'); return; }
    const listEl = document.getElementById('list');
    listEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>'; // NEW: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î

    const q = document.getElementById('q').value.trim();
    const category = document.getElementById('catFilter').value || '';
    const url = WEB_APP_BASE + '?' + toQS({ action:'list', idToken, q, page, pageSize, category });
    
    try {
      const r = await fetch(url);
      const j = await r.json().catch(()=>null);
      if (!r.ok || !j || j.error) throw new Error(j ? JSON.stringify(j) : 'Response not OK');
      renderList(j);
    } catch(err) {
      listEl.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏≠‡∏Å
      showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', err.message);
    }
  }

  function renderList(data) {
    const list = document.getElementById('list');
    list.innerHTML = '';
    if (!data.items || data.items.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    }

    (data.items || []).forEach(item => {
      const card = document.createElement('div');
      card.className = 'card';

      const img = document.createElement('img');
      img.className = 'thumb';
      img.src = item.imageUrl ? item.imageUrl : (item.imageId ? ('https://lh3.googleusercontent.com/d/' + item.imageId) : 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='); // Placeholder
      img.alt = '';

      const right = document.createElement('div');
      const h = document.createElement('h4');
      h.className = 'title';
      h.textContent = item.title || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠)';

      const meta = document.createElement('div');
      meta.className = 'meta';
      const owner = item.ownerEmail ? ` ‚Ä¢ ‡πÇ‡∏î‡∏¢ ${item.ownerEmail}` : '';
      const cat = item.category ? ` ‚Ä¢ ‡∏´‡∏°‡∏ß‡∏î ${item.category}` : '';
      meta.textContent = (item.createdAt ? new Date(item.createdAt).toLocaleString() : '') + owner + cat;

      const body = document.createElement('div');
      body.style.whiteSpace = 'pre-wrap'; // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ \n ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
      body.textContent = (item.body || '').slice(0,180) + ((item.body||'').length>180?'...':'');

      const actions = document.createElement('div');
      actions.className = 'actions';

      const reacts = document.createElement('div');
      reacts.style.display = 'flex'; reacts.style.gap = '8px';
      (async()=>{ try{ const rx = await fetchReactions(item.id); renderReactions(reacts, item.id, rx); }catch(e){} })();
      actions.appendChild(reacts);

      if (me && item.ownerEmail && me.email === item.ownerEmail) {
        const btnGroup = document.createElement('div');
        btnGroup.style.marginLeft = 'auto'; // ‡∏î‡∏±‡∏ô‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤
        btnGroup.style.display = 'flex'; btnGroup.style.gap = '8px';

        const editBtn = document.createElement('button');
        editBtn.className = 'ghost'; editBtn.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
        editBtn.addEventListener('click', ()=> openEdit(item));

        const delBtn = document.createElement('button');
        delBtn.className = 'danger'; delBtn.textContent = '‡∏•‡∏ö';
        delBtn.addEventListener('click', ()=> doDelete(item.id));

        btnGroup.appendChild(editBtn); btnGroup.appendChild(delBtn);
        actions.appendChild(btnGroup);
      }

      right.appendChild(h); right.appendChild(meta); right.appendChild(body); right.appendChild(actions);
      card.appendChild(img); card.appendChild(right);
      list.appendChild(card);
    });

    document.getElementById('pageInfo').textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${data.page} / ${data.totalPages} ‚Äì ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    document.getElementById('prev').disabled = data.page <= 1;
    document.getElementById('next').disabled = data.page >= data.totalPages;
  }

  // Search & Pager
  document.getElementById('btnSearch').addEventListener('click', ()=>{ page=1; loadList(); });
  document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ page=1; loadList(); e.preventDefault(); } });
  document.getElementById('prev').addEventListener('click', ()=>{ if(page>1){ page--; loadList(); }});
  document.getElementById('next').addEventListener('click', ()=>{ page++; loadList(); });

  // Dialog Add/Edit
  const dlg = document.getElementById('dlg');
  const dlgTitle = document.getElementById('dlgTitle');
  document.getElementById('btnAdd').addEventListener('click', openCreate);
  document.getElementById('closeDlg').addEventListener('click', ()=> dlg.style.display='none');

  function openCreate(){
    editingId = null;
    dlgTitle.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    document.getElementById('title').value = '';
    document.getElementById('body').value = '';
    document.getElementById('file').value = '';
    const catSel = document.getElementById('postCategory');
    if (catSel && catSel.options.length) catSel.selectedIndex = 0;
    dlg.style.display='flex';
  }
  function openEdit(item){
    editingId = item.id;
    dlgTitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå';
    document.getElementById('title').value = item.title || '';
    document.getElementById('body').value = item.body || '';
    document.getElementById('file').value = '';
    const catSel = document.getElementById('postCategory');
    if (catSel) {
      const ix = [...catSel.options].findIndex(o=>o.value===item.category);
      catSel.selectedIndex = ix>=0 ? ix : 0;
    }
    dlg.style.display='flex';
  }

  document.getElementById('save').addEventListener('click', async (evt)=>{
    if (!idToken) { showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ'); return; }
    const title = document.getElementById('title').value.trim();
    const body  = document.getElementById('body').value.trim();
    const file  = document.getElementById('file').files[0];
    const category = (document.getElementById('postCategory')?.value || '').trim();
    if (!title) { showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠'); return; }

    // --- NEW: ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≠‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ---
    const saveBtn = evt.target;
    const originalText = saveBtn.textContent;
    saveBtn.disabled = true;
    saveBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

    try {
      let imageData = '';
      if (file) imageData = await fileToDataURL(file);

      const form = new URLSearchParams();
      form.set('idToken', idToken);
      form.set('title', title);
      form.set('body', body);
      if (category) form.set('category', category);
      if (imageData) form.set('imageData', imageData);

      if (editingId) { form.set('action','update'); form.set('id', editingId); }
      else { form.set('action','create'); }

      const r = await fetch(WEB_APP_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form.toString() });
      const j = await r.json().catch(()=>null);
      if (!r.ok || (j && j.error)) throw new Error(j ? JSON.stringify(j) : 'Save failed');
      
      dlg.style.display='none';
      showSuccess(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
      page = 1; loadList();

    } catch(err) {
      showError(`${editingId?'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç':'‡∏™‡∏£‡πâ‡∏≤‡∏á'} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, err.message);
    } finally {
      // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
      saveBtn.disabled = false;
      saveBtn.textContent = originalText;
    }
  });

  async function doDelete(id){
    if (!idToken) { showError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ'); return; }
    
    // --- MODIFIED: ‡πÉ‡∏ä‡πâ SweetAlert2 ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ---
    const result = await Swal.fire({
      title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
      text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÅ‡∏≠‡∏Ñ‡∏ä‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    });

    if (result.isConfirmed) {
      try {
        const form = new URLSearchParams();
        form.set('action','delete'); form.set('idToken', idToken); form.set('id', id);
        const r = await fetch(WEB_APP_BASE, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form.toString() });
        const j = await r.json().catch(()=>null);
        if (!r.ok || (j && j.error)) throw new Error(j ? JSON.stringify(j) : 'Delete failed');
        
        showSuccess('‡∏•‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        loadList();
      } catch (err) {
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', err.message);
      }
    }
  }

  function fileToDataURL(file) {
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }
</script>
</body>
</html>
