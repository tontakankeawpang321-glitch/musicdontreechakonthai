<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>อ่านกระทู้</title>
<style>
  :root{
    --bg:#f9fafb; --paper:#fff; --ink:#111827; --muted:#6b7280;
    --line:#e5e7eb; --brand:#2563eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:"Sarabun",system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai",sans-serif;line-height:1.7}
  a{color:var(--brand);text-decoration:none}
  a:hover{text-decoration:underline}
  header{background:#1e40af;color:#fff;padding:10px 14px;font-weight:600}
  main{max-width:900px;margin:auto;background:var(--paper);border:1px solid var(--line);border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.06);padding:16px;margin-top:14px}
  .title{font-size:1.25rem;font-weight:700;margin:0 0 10px 0}
  .meta{font-size:13px;color:var(--muted);margin-bottom:12px}
  .content{padding:12px 14px;background:#fefefe;border:1px solid var(--line);border-radius:6px}
  .content img{max-width:100%;border-radius:6px;margin:6px 0}
  .content pre{background:#f3f4f6;padding:10px;border-radius:6px;overflow-x:auto;font-family:monospace;font-size:13px}
  .content code{background:#f3f4f6;padding:2px 4px;border-radius:4px}
  .actions{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap}
  button{background:#2563eb;color:#fff;border:0;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:14px}
  button:hover{background:#1e3a8a}
  footer{max-width:900px;margin:auto;color:var(--muted);font-size:13px;text-align:center;padding:16px 0}
</style>
</head>
<body>
<header>อ่านกระทู้</header>

<main>
  <div class="title" id="postTitle">กำลังโหลด...</div>
  <div class="meta" id="postMeta"></div>
  <div class="content" id="postBody">โปรดรอสักครู่...</div>
  <div class="actions">
    <button onclick="history.back()">« กลับ</button>
    <button id="replyBtn" onclick="alert('TODO: หน้าตอบกลับ')">ตอบกลับ</button>
  </div>
</main>

<footer>© <span id="year"></span> Webboard Demo</footer>

<script>
const WEB_APP_BASE = 'https://script.google.com/macros/s/AKfycbySSYD2QpQxWsX7Len5J2k_PlFdgdqZyZV7q-TiBXXj9bkg93hfsZYCT9DBvlWi7slMJg/exec';
document.getElementById('year').textContent=new Date().getFullYear();
function qs(k){return new URLSearchParams(location.search).get(k)||''}

/* Allowlist sanitizer (พื้นฐาน) */
function sanitizeBasic(html){
  if(!html) return '';
  // escape ทั้งหมดก่อน
  let s = String(html).replace(/</g,'&lt;').replace(/>/g,'&gt;');

  // อนุญาตแท็กที่จำเป็น
  const allowTags = ['b','i','u','pre','code'];
  allowTags.forEach(t=>{
    const reOpen  = new RegExp(`&lt;${t}&gt;`,'gi');
    const reClose = new RegExp(`&lt;\\/${t}&gt;`,'gi');
    s = s.replace(reOpen, `<${t}>`).replace(reClose, `</${t}>`);
  });

  // ลิงก์
  s = s
    .replace(/&lt;a href=(&quot;|')([^"'<>]+)\1&gt;/gi, '<a href="$2" target="_blank" rel="noopener">')
    .replace(/&lt;\/a&gt;/gi, '</a>');

  // รูป (เฉพาะ http/https/data)
  s = s
    .replace(/&lt;img src=(&quot;|')(https?:\/\/[^"'<>]+|data:image\/[a-zA-Z+]+;base64,[^"'<>]+)\1\s*\/?&gt;/gi, '<img src="$2">');

  // สี/สไตล์ inline (จำกัดเฉพาะ color:#xxxxxx หรือ rgb/rgba)
  s = s
    .replace(/&lt;span style=(&quot;|')color:\s*(#[0-9a-fA-F]{3,6}|rgba?\([^)]+\))\1&gt;/gi, '<span style="color:$2">')
    .replace(/&lt;\/span&gt;/gi, '</span>');

  return s;
}

async function loadPost(){
  const id = qs('id');
  if(!id){ document.getElementById('postTitle').textContent='ไม่พบรหัสโพสต์'; return; }
  try{
    const r = await fetch(WEB_APP_BASE+'?action=view&id='+encodeURIComponent(id));
    const j = await r.json();
    if(!r.ok || j.error) throw new Error(j.error||'โหลดไม่สำเร็จ');

    const p = j.item || j;
    document.getElementById('postTitle').textContent = p.title || '(ไม่มีหัวข้อ)';
    document.getElementById('postMeta').textContent =
      (p.ownerEmail?`โดย ${p.ownerEmail} • `:'') +
      (p.category?`หมวด: ${p.category} • `:'') +
      (p.createdAt ? new Date(p.createdAt).toLocaleString() : '');

    let html = p.body || '';
    document.getElementById('postBody').innerHTML = sanitizeBasic(html);

    // แนบรูป preview (ถ้ามี imageUrl บนหัวโพสต์)
    if(p.imageUrl){
      const img = document.createElement('img');
      img.src = p.imageUrl; img.alt=''; img.style.marginTop='8px';
      document.getElementById('postBody').prepend(img);
    }
  }catch(err){
    document.getElementById('postTitle').textContent='โหลดโพสต์ไม่สำเร็จ';
    document.getElementById('postBody').textContent=err.message;
  }
}
loadPost();
</script>
</body>
</html>
