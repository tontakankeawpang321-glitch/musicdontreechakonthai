<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hybrid Guitar Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');

        body {
            font-family: 'Kanit', sans-serif;
            background-color: #1a1a1a;
            color: #fff;
            overflow: hidden;
            touch-action: none; /* Disable native touch gestures */
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
            /* Fit Screen Logic */
            height: 100vh; 
            height: 100dvh; /* Dynamic Viewport Height for mobile browsers */
            width: 100vw;
            display: flex;
            flex-direction: column;
            overscroll-behavior: none; /* Prevent pull-to-refresh */
        }

        /* --- Layout --- */
        .top-controls {
            height: 50px;
            background: #262626;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 8px;
            border-bottom: 2px solid #444;
            z-index: 50;
            overflow-x: auto;
            flex-shrink: 0; /* Prevent shrinking */
            scrollbar-width: none; /* Hide scrollbar Firefox */
        }
        .top-controls::-webkit-scrollbar {
            display: none; /* Hide scrollbar Chrome/Safari */
        }

        /* Fretboard Section (Top Half) */
        .neck-container {
            flex: 1; /* Takes available space */
            background: #3e2723;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 -20px 40px rgba(0,0,0,0.8);
            border-bottom: 8px solid #1a1a1a; /* Separator */
        }

        /* Strum Section (Bottom Half) */
        .body-container {
            height: 38%; /* Adjusted for better proportion */
            min-height: 200px;
            background: #5d4037;
            position: relative;
            overflow: hidden;
            background: radial-gradient(circle at 50% 120%, #8d6e63 10%, #5d4037 60%, #3e2723 100%);
            flex-shrink: 0; /* Prevent shrinking */
        }

        .soundhole {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 300px;
            background: #111;
            border-radius: 50%;
            border: 15px solid #3e2723;
            box-shadow: inset 0 0 40px #000;
        }

        /* --- Guitar Elements --- */
        
        /* Strings (Horizontal) */
        .string-row {
            position: absolute;
            left: 0;
            right: 0;
            height: 24px; /* Increased Hit area height for easier touch */
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            z-index: 20;
            pointer-events: none; /* Logic handles touch */
        }

        .string-line {
            width: 100%;
            height: 2px;
            background: linear-gradient(to bottom, #ddd, #fff, #999);
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* String Thicknesses */
        .s5 .string-line { height: 5px; background: #d4af37; } /* Low E */
        .s4 .string-line { height: 4px; background: #d4af37; }
        .s3 .string-line { height: 3px; background: #d4af37; }
        .s2 .string-line { height: 2px; background: #fff; }
        .s1 .string-line { height: 1.5px; background: #fff; }
        .s0 .string-line { height: 1px; background: #fff; }

        /* Frets (Vertical Lines) */
        .fret-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to right, #90a4ae, #b0bec5, #78909c);
            z-index: 10;
            pointer-events: none;
            box-shadow: 2px 0 5px rgba(0,0,0,0.3);
        }

        .nut {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 12px;
            background: #d7ccc8;
            z-index: 15;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
        }

        /* Markers */
        .fret-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        /* Finger Press Indicator */
        .finger-dot {
            position: absolute;
            width: 24px;
            height: 24px;
            background: rgba(255, 193, 7, 0.9);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(255,193,7, 0.8);
            z-index: 30;
            display: none;
        }
        .finger-dot.active { display: block; }

        /* Animation */
        @keyframes vibrate-v {
            0% { transform: translateY(0); }
            25% { transform: translateY(-2px); }
            50% { transform: translateY(0); }
            75% { transform: translateY(2px); }
            100% { transform: translateY(0); }
        }
        .vibrating .string-line {
            animation: vibrate-v 0.08s infinite linear;
        }

        /* Buttons */
        .btn-control {
            background: #333;
            border: 1px solid #555;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
        }
        .chord-btn {
            background: #4e342e;
            color: #ffccbc;
            border: 1px solid #6d4c41;
            padding: 6px 14px;
            border-radius: 14px;
            font-size: 14px;
            min-width: 44px;
            text-align: center;
            font-weight: bold;
        }
        .chord-btn:active { background: #6d4c41; }
        
        .fret-number {
            position: absolute;
            bottom: 4px;
            font-size: 10px;
            color: #aaa;
            transform: translateX(-50%);
        }

        /* Touch Layers */
        #neckTouch, #bodyTouch {
            position: absolute;
            inset: 0;
            z-index: 50;
        }
    </style>
</head>
<body>

    <!-- Controls -->
    <div class="top-controls">
        <button id="recordBtn" class="btn-control text-red-400 border-red-900/50 bg-red-900/20 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-red-500 block"></span> Rec
        </button>
        <div class="w-[1px] h-6 bg-gray-600 mx-1"></div>
        <button class="chord-btn" onclick="setChord('C')">C</button>
        <button class="chord-btn" onclick="setChord('D')">D</button>
        <button class="chord-btn" onclick="setChord('E')">E</button>
        <button class="chord-btn" onclick="setChord('F')">F</button>
        <button class="chord-btn" onclick="setChord('G')">G</button>
        <button class="chord-btn" onclick="setChord('A')">A</button>
        <button class="chord-btn" onclick="setChord('Em')">Em</button>
        <button class="chord-btn bg-stone-700 border-stone-600 text-stone-300" onclick="clearChords()">Free</button>
    </div>

    <!-- Top: Neck (Fretboard) -->
    <div class="neck-container" id="neckContainer">
        <div class="nut"></div>
        <!-- Generated via JS -->
        <div id="neckTouch"></div>
    </div>

    <!-- Bottom: Body (Strumming) -->
    <div class="body-container" id="bodyContainer">
        <div class="soundhole"></div>
        <!-- Generated via JS -->
        <div id="bodyTouch"></div>
        <div class="absolute bottom-4 w-full text-center text-white/30 text-sm font-light pointer-events-none tracking-wider">
            STRUM HERE
        </div>
    </div>

    <!-- Start Overlay -->
    <div id="startOverlay" class="fixed inset-0 z-[100] bg-black/90 flex flex-col items-center justify-center cursor-pointer backdrop-blur-md">
        <div class="bg-amber-700 p-6 rounded-full mb-4 animate-pulse shadow-[0_0_30px_rgba(180,83,9,0.5)]">
            <span class="text-4xl text-white">▶</span>
        </div>
        <h2 class="text-xl font-bold text-white mb-2">แตะเพื่อเล่น (Tap to Start)</h2>
        <p class="text-gray-400 text-xs">Full Screen Experience</p>
    </div>

    <script>
        // --- Configuration ---
        const config = {
            strings: 6,
            visibleFrets: 5, 
            baseFreqs: [82.41, 110.00, 146.83, 196.00, 246.94, 329.63].reverse() 
        };

        const stringFreqs = [82.41, 110.00, 146.83, 196.00, 246.94, 329.63]; 

        let stringState = [0, 0, 0, 0, 0, 0];
        let isChordMode = false;
        const markers = [];

        // --- Audio Context ---
        let audioCtx;
        let masterGain;
        let compressor;
        let noiseBuffer;
        const activeVoices = new Array(6).fill(null);

        // Recording
        let recorderDest;
        let mediaRecorder;
        let chunks = [];
        let isRecording = false;

        function initAudio() {
            if (audioCtx) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext({ latencyHint: 'interactive' });
            
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.8;

            compressor = audioCtx.createDynamicsCompressor();
            compressor.threshold.value = -18;
            compressor.ratio.value = 10;

            recorderDest = audioCtx.createMediaStreamDestination();

            compressor.connect(masterGain);
            masterGain.connect(audioCtx.destination);
            masterGain.connect(recorderDest);

            const size = audioCtx.sampleRate * 0.05;
            noiseBuffer = audioCtx.createBuffer(1, size, audioCtx.sampleRate);
            const data = noiseBuffer.getChannelData(0);
            for(let i=0; i<size; i++) data[i] = (Math.random()*2 - 1) * 0.5;

            document.getElementById('startOverlay').classList.add('opacity-0', 'pointer-events-none');
        }

        function playString(index, velocity = 1.0) {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const fret = stringState[index];
            if (fret === -1) return;

            const freq = stringFreqs[index] * Math.pow(2, fret / 12);
            const t = audioCtx.currentTime;

            if (activeVoices[index]) {
                try {
                    const v = activeVoices[index];
                    v.gain.gain.cancelScheduledValues(t);
                    v.gain.gain.setValueAtTime(v.gain.gain.value, t);
                    v.gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.05);
                    v.osc.stop(t + 0.05);
                } catch(e) {}
            }

            const osc = audioCtx.createOscillator();
            const filter = audioCtx.createBiquadFilter();
            const gain = audioCtx.createGain();

            osc.type = 'sawtooth';
            osc.frequency.value = freq;

            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(3000, t);
            filter.frequency.exponentialRampToValueAtTime(100, t + 4.0);

            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(0.4 * velocity, t + 0.005);
            gain.gain.exponentialRampToValueAtTime(0.0001, t + 3.0);

            const nSrc = audioCtx.createBufferSource();
            nSrc.buffer = noiseBuffer;
            const nGain = audioCtx.createGain();
            nGain.gain.setValueAtTime(0.15 * velocity, t);
            nGain.gain.exponentialRampToValueAtTime(0.001, t + 0.02);

            osc.connect(filter);
            filter.connect(gain);
            gain.connect(compressor);
            nSrc.connect(nGain);
            nGain.connect(compressor);

            osc.start(t);
            nSrc.start(t);
            osc.stop(t + 5);

            activeVoices[index] = { osc, gain };

            animateString(index);
            if(navigator.vibrate) navigator.vibrate(10);
        }

        // --- UI Construction ---
        const neckContainer = document.getElementById('neckContainer');
        const bodyContainer = document.getElementById('bodyContainer');

        function buildUI() {
            for(let s=0; s<6; s++) {
                const topPos = (s + 0.5) * (100 / 6);
                const strN = createStringEl(s, topPos, true); 
                neckContainer.appendChild(strN);
                const strB = createStringEl(s, topPos, false);
                bodyContainer.appendChild(strB);

                const dot = document.createElement('div');
                dot.className = 'finger-dot';
                neckContainer.appendChild(dot);
                markers.push(dot);
            }

            const fretWidth = 100 / (config.visibleFrets + 0.5); 

            for(let f=1; f<=config.visibleFrets; f++) {
                const line = document.createElement('div');
                line.className = 'fret-line';
                line.style.left = `${f * fretWidth}%`;
                neckContainer.appendChild(line);

                const num = document.createElement('div');
                num.className = 'fret-number';
                num.textContent = f;
                num.style.left = `${(f - 0.5) * fretWidth}%`;
                neckContainer.appendChild(num);

                if(f===3 || f===5) {
                   const dot = document.createElement('div');
                   dot.className = 'fret-marker';
                   dot.style.left = `${(f - 0.5) * fretWidth}%`;
                   dot.style.top = '50%';
                   neckContainer.appendChild(dot);
                }
            }
        }

        function createStringEl(index, topPerc, isNeck) {
            const el = document.createElement('div');
            el.className = `string-row`;
            el.style.top = `${topPerc}%`;
            const thicknessClass = `s${5 - index}`; 
            el.dataset.idx = index;
            el.dataset.loc = isNeck ? 'neck' : 'body';
            const line = document.createElement('div');
            line.className = `string-line ${thicknessClass}`;
            el.appendChild(line);
            return el;
        }

        function animateString(idx) {
            const targets = document.querySelectorAll(`.string-row[data-idx="${idx}"]`);
            targets.forEach(el => {
                el.classList.remove('vibrating');
                void el.offsetWidth;
                el.classList.add('vibrating');
                setTimeout(() => el.classList.remove('vibrating'), 300);
            });
        }

        // --- Interaction ---
        const neckTouch = document.getElementById('neckTouch');
        neckTouch.addEventListener('touchstart', handleNeck, {passive:false});
        neckTouch.addEventListener('touchmove', handleNeck, {passive:false});
        neckTouch.addEventListener('touchend', handleNeck, {passive:false});

        function handleNeck(e) {
            e.preventDefault();
            initAudio();
            const currentTouches = {}; 
            const rect = neckContainer.getBoundingClientRect();
            for(let i=0; i<e.touches.length; i++) {
                const t = e.touches[i];
                if(t.clientY >= rect.top && t.clientY <= rect.bottom) {
                    const yPerc = (t.clientY - rect.top) / rect.height;
                    const sIdx = Math.floor(yPerc * 6);
                    const xPerc = (t.clientX - rect.left) / rect.width;
                    const fretWidthPerc = 1 / (config.visibleFrets + 0.5);
                    const fretNum = Math.ceil(xPerc / fretWidthPerc);
                    if(sIdx >=0 && sIdx < 6 && fretNum > 0 && fretNum <= config.visibleFrets) {
                        currentTouches[sIdx] = fretNum;
                    }
                }
            }
            for(let s=0; s<6; s++) {
                if(currentTouches[s]) {
                    stringState[s] = currentTouches[s];
                    const fretWidth = 100 / (config.visibleFrets + 0.5);
                    markers[s].style.left = `${(stringState[s] - 0.5) * fretWidth}%`;
                    markers[s].style.top = `${(s + 0.5) * (100/6)}%`;
                    markers[s].classList.add('active');
                } else if(!isChordMode) {
                    stringState[s] = 0;
                    markers[s].classList.remove('active');
                }
            }
        }

        const bodyTouch = document.getElementById('bodyTouch');
        const lastStrum = [0,0,0,0,0,0];

        bodyTouch.addEventListener('touchstart', handleStrum, {passive:false});
        bodyTouch.addEventListener('touchmove', handleStrum, {passive:false});

        function handleStrum(e) {
            e.preventDefault();
            initAudio();
            const rect = bodyContainer.getBoundingClientRect();
            for(let i=0; i<e.touches.length; i++) {
                const t = e.touches[i];
                if(t.clientY >= rect.top && t.clientY <= rect.bottom) {
                    const yPerc = (t.clientY - rect.top) / rect.height;
                    const sIdx = Math.floor(yPerc * 6);
                    if(sIdx >=0 && sIdx < 6) {
                        const now = Date.now();
                        if(now - lastStrum[sIdx] > 60) {
                            playString(sIdx);
                            lastStrum[sIdx] = now;
                        }
                    }
                }
            }
        }

        const chords = {
            'C': [-1, 3, 2, 0, 1, 0],
            'D': [-1, -1, 0, 2, 3, 2],
            'E': [0, 2, 2, 1, 0, 0],
            'F': [1, 3, 3, 2, 1, 1],
            'G': [3, 2, 0, 0, 0, 3],
            'A': [-1, 0, 2, 2, 2, 0],
            'Em': [0, 2, 2, 0, 0, 0]
        };

        window.setChord = function(name) {
            isChordMode = true;
            const shape = chords[name];
            if(shape) {
                markers.forEach(m => m.classList.remove('active'));
                for(let s=0; s<6; s++) {
                    stringState[s] = shape[s];
                    if(shape[s] > 0) {
                        const fretWidth = 100 / (config.visibleFrets + 0.5);
                        markers[s].style.left = `${(shape[s] - 0.5) * fretWidth}%`;
                        markers[s].style.top = `${(s + 0.5) * (100/6)}%`;
                        markers[s].classList.add('active');
                    }
                }
            }
        };

        window.clearChords = function() {
            isChordMode = false;
            stringState = [0,0,0,0,0,0];
            markers.forEach(m => m.classList.remove('active'));
        };

        const recordBtn = document.getElementById('recordBtn');
        recordBtn.addEventListener('click', () => {
            initAudio();
            if(!isRecording) {
                chunks = [];
                mediaRecorder = new MediaRecorder(recorderDest.stream);
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, {'type':'audio/wav'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display='none';
                    a.href=url;
                    a.download = `rec-${Date.now()}.wav`;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(()=>a.remove(), 100);
                };
                mediaRecorder.start();
                isRecording = true;
                recordBtn.innerHTML = '<span class="w-2 h-2 rounded-full bg-white animate-pulse block"></span> Stop';
                recordBtn.classList.add('bg-red-600', 'text-white');
            } else {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 block"></span> Rec';
                recordBtn.classList.remove('bg-red-600', 'text-white');
            }
        });

        document.getElementById('startOverlay').addEventListener('click', initAudio);
        document.getElementById('startOverlay').addEventListener('touchstart', initAudio);
        buildUI();
    </script>
</body>
</html>
