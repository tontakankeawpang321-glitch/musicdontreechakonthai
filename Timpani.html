<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Timpani Pro Simulator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');

        * {
            box-sizing: border-box;
            touch-action: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            user-select: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            background: radial-gradient(circle, #2c2c2c 0%, #000000 100%);
            height: 100vh;
            height: 100dvh; /* ‡πÉ‡∏ä‡πâ Dynamic Viewport Height ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÜ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Sarabun', sans-serif;
            overflow: hidden;
            color: white;
        }

        header {
            position: absolute;
            top: 20px;
            text-align: center;
            z-index: 10;
            pointer-events: none;
            width: 100%;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            color: #d4af37; /* ‡∏™‡∏µ‡∏ó‡∏≠‡∏á */
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á */
        .controls {
            pointer-events: auto;
            margin-top: 10px;
        }

        #record-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #d4af37;
            color: #d4af37;
            padding: 8px 20px;
            border-radius: 20px;
            font-family: 'Sarabun', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        #record-btn.recording {
            background: rgba(220, 20, 60, 0.8);
            border-color: crimson;
            color: white;
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 20, 60, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 20, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 20, 60, 0); }
        }

        p {
            margin: 5px 0 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡∏Å‡∏•‡∏≠‡∏á */
        .drum-container {
            display: flex;
            justify-content: center;
            align-items: center; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
            align-content: center; /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
            flex-wrap: wrap;
            gap: 15px; /* ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
            width: 100%;
            height: 100%;
            padding: 10px;
            max-width: 1200px;
        }

        /* ‡∏ï‡∏±‡∏ß‡∏Å‡∏•‡∏≠‡∏á */
        .timpani {
            position: relative;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.05s ease;
            box-shadow: 
                0 10px 30px rgba(0,0,0,0.8),
                inset 0 0 20px rgba(0,0,0,0.5);
            /* ‡∏•‡∏≤‡∏¢‡∏ó‡∏≠‡∏á‡πÅ‡∏î‡∏á */
            background: linear-gradient(135deg, #b87333 0%, #6d4c41 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
        }

        /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏≠‡∏ô‡∏Å‡∏î */
        .timpani.active {
            transform: scale(0.96);
        }

        /* ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏≠‡∏á (Head) */
        .head {
            width: 92%;
            height: 92%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fdfbf7 0%, #e6e0d4 60%, #c5bba8 100%);
            box-shadow: 
                inset 0 0 10px rgba(0,0,0,0.2),
                0 0 5px rgba(0,0,0,0.3);
            position: relative;
            pointer-events: none; /* ‡πÉ‡∏´‡πâ event ‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏°‡πà */
        }

        /* ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏ö‡∏Å‡∏•‡∏≠‡∏á */
        .rim {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 8px solid #5d4037;
            box-shadow: 
                inset 0 2px 5px rgba(255,255,255,0.3),
                0 2px 5px rgba(0,0,0,0.5);
            pointer-events: none;
        }

        /* ‡∏õ‡πâ‡∏≤‡∏¢‡∏ö‡∏≠‡∏Å‡πÇ‡∏ô‡πâ‡∏ï */
        .label {
            position: absolute;
            bottom: 15%;
            font-weight: bold;
            color: rgba(0,0,0,0.6);
            font-size: 1.2rem;
            pointer-events: none;
        }

        /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏•‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ Fit Screen ‡πÄ‡∏™‡∏°‡∏≠ */
        /* ‡πÉ‡∏ä‡πâ vmin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏¥‡∏á‡∏Å‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≠‡∏ô) */
        .size-32 { width: 40vmin; height: 40vmin; max-width: 280px; max-height: 280px; }
        .size-29 { width: 36vmin; height: 36vmin; max-width: 250px; max-height: 250px; }
        .size-26 { width: 32vmin; height: 32vmin; max-width: 220px; max-height: 220px; }
        .size-23 { width: 28vmin; height: 28vmin; max-width: 200px; max-height: 200px; }

        /* Media Queries ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
        @media (orientation: landscape) {
            .drum-container {
                gap: 20px;
            }
            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ï‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô */
            .size-32 { width: 35vh; height: 35vh; max-width: 350px; max-height: 350px; }
            .size-29 { width: 31vh; height: 31vh; max-width: 310px; max-height: 310px; }
            .size-26 { width: 27vh; height: 27vh; max-width: 270px; max-height: 270px; }
            .size-23 { width: 23vh; height: 23vh; max-width: 230px; max-height: 230px; }
        }

        /* Overlay ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s;
        }
        
        #start-btn {
            padding: 15px 40px;
            font-size: 1.5rem;
            background: #d4af37;
            color: #1a1a1a;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }

    </style>
</head>
<body>

    <header>
        <h1>Timpani Simulator</h1>
        <div class="controls">
            <button id="record-btn">üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
        </div>
        <p>‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Multi-touch</p>
    </header>

    <div id="start-overlay">
        <button id="start-btn">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</button>
        <p style="margin-top: 20px; color: #ccc;">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏´‡∏π‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á</p>
    </div>

    <div class="drum-container">
        <!-- ‡∏Å‡∏•‡∏≠‡∏á‡πÉ‡∏ö‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏´‡∏ç‡πà‡∏™‡∏∏‡∏î ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î (D2) -->
        <div class="timpani size-32" data-freq="73.42" data-note="D2">
            <div class="rim"></div>
            <div class="head"></div>
            <div class="label">D</div>
        </div>

        <!-- ‡∏Å‡∏•‡∏≠‡∏á‡πÉ‡∏ö‡∏ó‡∏µ‡πà 2: (F2) -->
        <div class="timpani size-29" data-freq="87.31" data-note="F2">
            <div class="rim"></div>
            <div class="head"></div>
            <div class="label">F</div>
        </div>

        <!-- ‡∏Å‡∏•‡∏≠‡∏á‡πÉ‡∏ö‡∏ó‡∏µ‡πà 3: (A2) -->
        <div class="timpani size-26" data-freq="110.00" data-note="A2">
            <div class="rim"></div>
            <div class="head"></div>
            <div class="label">A</div>
        </div>

        <!-- ‡∏Å‡∏•‡∏≠‡∏á‡πÉ‡∏ö‡∏ó‡∏µ‡πà 4: ‡πÄ‡∏•‡πá‡∏Å‡∏™‡∏∏‡∏î ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (C3) -->
        <div class="timpani size-23" data-freq="130.81" data-note="C3">
            <div class="rim"></div>
            <div class="head"></div>
            <div class="label">C</div>
        </div>
    </div>

    <script>
        // --- Audio Engine ---
        let audioCtx;
        let masterCompressor = null; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô let ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢
        let mediaStreamDest = null;  // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                
                // Master Compressor ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ï‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏µ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÉ‡∏ö
                const comp = audioCtx.createDynamicsCompressor();
                comp.threshold.setValueAtTime(-24, audioCtx.currentTime);
                comp.knee.setValueAtTime(30, audioCtx.currentTime);
                comp.ratio.setValueAtTime(12, audioCtx.currentTime);
                comp.attack.setValueAtTime(0.003, audioCtx.currentTime);
                comp.release.setValueAtTime(0.25, audioCtx.currentTime);
                
                // Route: Compressor -> Destination (‡∏•‡∏≥‡πÇ‡∏û‡∏á)
                comp.connect(audioCtx.destination);
                
                // Route: Compressor -> MediaStreamDestination (‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á)
                const dest = audioCtx.createMediaStreamDestination();
                comp.connect(dest);
                
                window.masterCompressor = comp; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                mediaStreamDest = dest;         // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            }
            
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // --- Recording Logic ---
        const recordBtn = document.getElementById('record-btn');

        function toggleRecording() {
            if (!audioCtx) initAudio();

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!mediaStreamDest) return;
            
            recordedChunks = [];
            // ‡πÉ‡∏ä‡πâ mimetype ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà Browser ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
            const options = { mimeType: 'audio/webm' };
            
            try {
                mediaRecorder = new MediaRecorder(mediaStreamDest.stream, options);
            } catch (e) {
                // Fallback ‡∏ñ‡πâ‡∏≤ audio/webm ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (‡πÄ‡∏ä‡πà‡∏ô Safari ‡∏ö‡∏≤‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô)
                console.warn('audio/webm not supported, trying default.');
                mediaRecorder = new MediaRecorder(mediaStreamDest.stream);
            }

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    recordedChunks.push(e.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
                const now = new Date();
                const timestamp = `${now.getHours()}-${now.getMinutes()}-${now.getSeconds()}`;
                a.download = `timpani-recording-${timestamp}.webm`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 100);
            };

            mediaRecorder.start();
            isRecording = true;
            recordBtn.textContent = '‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            recordBtn.classList.add('recording');
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
                recordBtn.textContent = 'üî¥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
                recordBtn.classList.remove('recording');
            }
        }

        recordBtn.addEventListener('click', toggleRecording);

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á Timpani ‡πÅ‡∏ö‡∏ö‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á (Additive Synthesis)
        // Timpani ‡∏°‡∏µ Harmonics ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏ó‡πà‡∏≤ ‡∏ã‡∏∂‡πà‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå
        function playTimpaniSound(frequency, velocity = 1.0) {
            if (!audioCtx) return;

            const t = audioCtx.currentTime;
            const masterGain = audioCtx.createGain();
            masterGain.connect(window.masterCompressor);
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Å‡∏î (velocity)
            masterGain.gain.setValueAtTime(0, t);
            masterGain.gain.linearRampToValueAtTime(velocity, t + 0.005);
            masterGain.gain.exponentialRampToValueAtTime(0.001, t + 3.0); // ‡∏´‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏¢‡∏≤‡∏ß

            // Timpani Ratios (Mode ratios for a circular membrane)
            // 1.0 : Fundamental
            // 1.5 : Fifth (approx)
            // 1.98 : Near Octave
            // 2.44 : Major Third above octave
            const ratios = [1.0, 1.5, 1.98, 2.44];
            const gains  = [1.0, 0.6, 0.5,  0.3];
            const decays = [2.5, 1.5, 1.0,  0.8]; // ‡∏´‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏¢‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô

            ratios.forEach((ratio, index) => {
                const osc = audioCtx.createOscillator();
                const oscGain = audioCtx.createGain();
                
                osc.type = index === 0 ? 'sine' : 'triangle'; // ‡∏ú‡∏™‡∏° sine ‡∏Å‡∏±‡∏ö triangle ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤
                
                // Pitch Envelope: ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡∏•‡∏≠‡∏á‡∏à‡∏∞‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ï‡∏≠‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏Å‡∏•‡∏á
                osc.frequency.setValueAtTime(frequency * ratio * 1.02, t);
                osc.frequency.exponentialRampToValueAtTime(frequency * ratio, t + 0.1);

                // Gain Envelope ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Harmonic
                oscGain.gain.setValueAtTime(0, t);
                oscGain.gain.linearRampToValueAtTime(gains[index], t + 0.01);
                oscGain.gain.exponentialRampToValueAtTime(0.001, t + decays[index]);

                // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏∏‡πà‡∏°
                if (index > 0) {
                    const filter = audioCtx.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.value = frequency * 4;
                    osc.connect(oscGain);
                    oscGain.connect(filter);
                    filter.connect(masterGain);
                } else {
                    osc.connect(oscGain);
                    oscGain.connect(masterGain);
                }

                osc.start(t);
                osc.stop(t + 3.5);
            });

            // Impact Sound (‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏´‡∏ô‡∏±‡∏á‡∏Å‡∏•‡∏≠‡∏á) - Noise Burst
            const bufferSize = audioCtx.sampleRate * 0.05; // 50ms noise
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const noiseFilter = audioCtx.createBiquadFilter();
            noiseFilter.type = 'lowpass';
            noiseFilter.frequency.value = 800;
            
            const noiseGain = audioCtx.createGain();
            noiseGain.gain.setValueAtTime(0.3 * velocity, t);
            noiseGain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);

            noise.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(masterGain);
            noise.start(t);

            // Cleanup
            setTimeout(() => {
                masterGain.disconnect();
            }, 3500);
        }

        // --- UI & Interaction ---
        
        const drums = document.querySelectorAll('.timpani');
        const startBtn = document.getElementById('start-btn');
        const overlay = document.getElementById('start-overlay');

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏õ (‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å AudioContext)
        function startApp() {
            initAudio();
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 500);
        }

        startBtn.addEventListener('click', startApp);
        startBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô double fire
            startApp();
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏µ‡∏Å‡∏•‡∏≠‡∏á
        function hitDrum(element) {
            if (!audioCtx) return;

            const freq = parseFloat(element.dataset.freq);
            
            // Visual feedback
            element.classList.add('active');
            setTimeout(() => element.classList.remove('active'), 100);

            // Audio trigger
            // ‡∏™‡∏∏‡πà‡∏° velocity ‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥
            const velocity = 0.8 + Math.random() * 0.2;
            playTimpaniSound(freq, velocity);
        }

        // Setup Touch Events (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Multi-touch)
        drums.forEach(drum => {
            // Touchstart ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÑ‡∏ß‡∏™‡∏∏‡∏î)
            drum.addEventListener('touchstart', (e) => {
                e.preventDefault(); // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏´‡πâ‡∏≤‡∏° scroll/zoom
                // Loop ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏ô‡∏¥‡πâ‡∏ß‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡∏∞‡∏•‡∏á‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
                for (let i = 0; i < e.changedTouches.length; i++) {
                    hitDrum(drum);
                }
            }, { passive: false });

            // Mousedown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏≤‡∏™‡πå
            drum.addEventListener('mousedown', (e) => {
                if(e.button === 0) { // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                    hitDrum(drum);
                }
            });
        });

        // Keyboard Support (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏ô‡∏Ñ‡∏≠‡∏°)
        window.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            switch(e.key.toLowerCase()) {
                case 'a': hitDrum(drums[0]); break;
                case 's': hitDrum(drums[1]); break;
                case 'd': hitDrum(drums[2]); break;
                case 'f': hitDrum(drums[3]); break;
            }
        });

    </script>
</body>
</html>
