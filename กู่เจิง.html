<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guzheng Master - ‡∏Å‡∏π‡πà‡πÄ‡∏à‡∏¥‡∏á‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');

        :root {
            --wood-dark: #3e2723;
            --wood-light: #5d4037;
            --wood-texture: #8d6e63;
            --string-color: #f5f5f5;
            --string-green: #4caf50;
            --bridge-color: #d7ccc8;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            font-family: 'Sarabun', sans-serif;
            overflow: hidden; /* Prevent scrolling */
            touch-action: none; /* Disable default touch actions */
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: white;
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- Header & Controls --- */
        header {
            background: linear-gradient(to bottom, #212121, #000);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 10;
            height: 60px;
        }

        h1 {
            font-size: 1.2rem;
            margin: 0;
            color: #d4af37; /* Gold color */
            text-shadow: 1px 1px 2px black;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        button {
            background: #424242;
            border: 1px solid #616161;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        button:active {
            transform: scale(0.95);
        }

        button.active-record {
            background: #d32f2f;
            border-color: #ff5252;
            animation: pulse 1.5s infinite;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); }
            100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
        }

        /* --- Guzheng Board --- */
        .guzheng-container {
            flex-grow: 1;
            position: relative;
            background: 
                linear-gradient(90deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0) 10%, rgba(0,0,0,0) 90%, rgba(0,0,0,0.6) 100%),
                repeating-linear-gradient(45deg, var(--wood-dark) 0px, var(--wood-light) 2px, var(--wood-dark) 8px);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column; /* Strings stacked vertically */
            justify-content: center;
            padding: 20px 0;
            overflow: hidden;
            perspective: 1000px;
        }

        /* Ornamentation (Wood Grain overlay) */
        .guzheng-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.1'/%3E%3C/svg%3E");
            pointer-events: none;
        }

        /* Right side compartment (Visual only) */
        .tuning-box {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 15%;
            background: linear-gradient(to right, rgba(0,0,0,0.8), rgba(62, 39, 35, 0.9));
            border-left: 5px solid #281813;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.2);
            writing-mode: vertical-rl;
            font-size: 2rem;
            font-family: serif;
        }

        /* --- Strings Area --- */
        .strings-wrapper {
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            height: 100%;
            width: 85%; /* Leave room for tuning box */
            position: relative;
            padding-left: 20px;
        }

        .string-row {
            position: relative;
            width: 100%;
            height: 100%; /* Distribute evenly */
            display: flex;
            align-items: center;
        }

        /* The actual string line */
        .string {
            width: 100%;
            height: 3px; /* Slightly thicker for better touch target */
            background: var(--string-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            position: relative;
            z-index: 2;
            transition: transform 0.05s ease-in-out;
            cursor: pointer;
        }
        
        /* Expand Hit Area for Touch without changing visual size too much */
        .string::after {
            content: '';
            position: absolute;
            top: -10px;
            bottom: -10px;
            left: 0;
            right: 0;
            z-index: 10; /* Higher than visual string */
        }

        /* Green Strings (Usually 3, 8, 13, 18, 21) */
        .string.green {
            background: var(--string-green);
        }

        /* Bridge (The wooden support) */
        .bridge {
            position: absolute;
            width: 12px;
            height: 20px;
            background: linear-gradient(to bottom, #d7ccc8, #8d6e63);
            border-radius: 2px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.6);
            z-index: 1;
            /* Position bridges dynamically in JS to form the S-curve */
        }

        /* Note Label */
        .note-label {
            position: absolute;
            left: -10px;
            color: #ffca28;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            background: rgba(0,0,0,0.6);
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        .show-notes .note-label {
            opacity: 1;
        }

        /* Animation when playing */
        .string.vibrating {
            animation: vibrate 0.15s linear infinite;
            box-shadow: 0 0 5px #fff, 0 0 10px var(--string-green);
        }

        @keyframes vibrate {
            0% { transform: translateY(0); }
            25% { transform: translateY(-2px); }
            50% { transform: translateY(0); }
            75% { transform: translateY(2px); }
            100% { transform: translateY(0); }
        }

        /* Hint Overlay */
        #hint-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.92);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        
        #hint-overlay h2 { color: #d4af37; margin-bottom: 20px; }
        #hint-overlay p { color: #eee; margin-bottom: 30px; line-height: 1.6; }
        #hint-overlay button {
            background: #d4af37;
            color: black;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 15px 40px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            h1 { font-size: 1rem; }
            button { padding: 5px 8px; font-size: 0.8rem; }
            .tuning-box { width: 10%; }
            .strings-wrapper { width: 90%; }
        }
    </style>
</head>
<body>

    <!-- Start Overlay -->
    <div id="hint-overlay">
        <h2>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏Å‡∏π‡πà‡πÄ‡∏à‡∏¥‡∏á‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô‡∏à‡∏£‡∏¥‡∏á</h2>
        <p>‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô High Performance (‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£)<br>
        1. ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>
        2. ‡∏´‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô<br>
        3. ‡πÉ‡∏ä‡πâ‡∏ô‡∏¥‡πâ‡∏ß‡∏•‡∏≤‡∏Å‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏¢ (Glissando) ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏ö‡∏£‡∏∑‡πà‡∏ô</p>
        <button onclick="startApp()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô (Start)</button>
    </div>

    <header>
        <h1>Âè§Á≠ù Guzheng</h1>
        <div class="controls">
            <button id="btn-notes" onclick="toggleNotes()">‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏ô‡πâ‡∏ï</button>
            <button id="btn-record" onclick="toggleRecord()">üî¥ ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
            <button id="btn-play" onclick="playRecording()" disabled>‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô</button>
            <button id="btn-download" onclick="downloadRecording()" disabled>‚¨áÔ∏è ‡πÇ‡∏´‡∏•‡∏î</button>
        </div>
    </header>

    <div class="guzheng-container" id="board">
        <div class="tuning-box">Âè§Á≠ù</div>
        <div class="strings-wrapper" id="strings-area">
            <!-- Strings will be generated by JS -->
        </div>
    </div>

    <script>
        // --- Configuration ---
        const stringData = [
            { note: "D6", freq: 1174.66, isGreen: false }, // 1
            { note: "B5", freq: 987.77, isGreen: false },  // 2
            { note: "A5", freq: 880.00, isGreen: true },   // 3 (Green)
            { note: "F#5", freq: 739.99, isGreen: false }, // 4
            { note: "E5", freq: 659.25, isGreen: false },  // 5
            { note: "D5", freq: 587.33, isGreen: false },  // 6
            { note: "B4", freq: 493.88, isGreen: false },  // 7
            { note: "A4", freq: 440.00, isGreen: true },   // 8 (Green)
            { note: "F#4", freq: 369.99, isGreen: false }, // 9
            { note: "E4", freq: 329.63, isGreen: false },  // 10
            { note: "D4", freq: 293.66, isGreen: false },  // 11
            { note: "B3", freq: 246.94, isGreen: false },  // 12
            { note: "A3", freq: 220.00, isGreen: true },   // 13 (Green)
            { note: "F#3", freq: 185.00, isGreen: false }, // 14
            { note: "E3", freq: 164.81, isGreen: false },  // 15
            { note: "D3", freq: 146.83, isGreen: false },  // 16
            { note: "B2", freq: 123.47, isGreen: false },  // 17
            { note: "A2", freq: 110.00, isGreen: true },   // 18 (Green)
            { note: "F#2", freq: 92.50, isGreen: false },  // 19
            { note: "E2", freq: 82.41, isGreen: false },   // 20
            { note: "D2", freq: 73.42, isGreen: false },   // 21
        ];

        let audioCtx;
        let masterGain;
        let compressor;
        let dest; // For recording
        let mediaRecorder;
        let recordedChunks = [];
        let audioBlob;
        let audioUrl;
        let isRecording = false;

        // Initialize App
        function startApp() {
            document.getElementById('hint-overlay').style.display = 'none';
            initAudio();
            renderStrings();
        }

        // --- Audio Engine (Optimized) ---
        function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext({
                latencyHint: 'interactive' // Hint browser to prioritize low latency
            });
            
            // 1. Create Compressor to prevent clipping (Distortion)
            compressor = audioCtx.createDynamicsCompressor();
            compressor.threshold.setValueAtTime(-24, audioCtx.currentTime);
            compressor.knee.setValueAtTime(30, audioCtx.currentTime);
            compressor.ratio.setValueAtTime(12, audioCtx.currentTime);
            compressor.attack.setValueAtTime(0.003, audioCtx.currentTime);
            compressor.release.setValueAtTime(0.25, audioCtx.currentTime);

            // 2. Master volume
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.8; // Safe level entering compressor

            // 3. Routing: Inputs -> MasterGain -> Compressor -> Destination
            masterGain.connect(compressor);
            compressor.connect(audioCtx.destination);

            // Setup Recording Destination from Compressor output
            dest = audioCtx.createMediaStreamDestination();
            compressor.connect(dest);
        }

        function playSound(freq) {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const t = audioCtx.currentTime;

            // 1. Oscillator
            const osc = audioCtx.createOscillator();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq, t);

            // 2. Filter (Pluck character)
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.Q.value = 1; // Slight resonance
            filter.frequency.setValueAtTime(3500, t);
            filter.frequency.exponentialRampToValueAtTime(200, t + 0.3);

            // 3. Envelope
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(1, t + 0.015); // Fast attack
            gain.gain.exponentialRampToValueAtTime(0.001, t + 2.5); // Sustain

            // Connect
            osc.connect(filter);
            filter.connect(gain);
            gain.connect(masterGain);

            // Start
            osc.start(t);
            osc.stop(t + 2.5);

            // Important: Cleanup to prevent memory leaks and audio dropouts
            osc.onended = () => {
                osc.disconnect();
                filter.disconnect();
                gain.disconnect();
            };
        }

        // --- Visuals & DOM ---
        function renderStrings() {
            const container = document.getElementById('strings-area');
            container.innerHTML = '';

            stringData.forEach((s, index) => {
                const row = document.createElement('div');
                row.className = 'string-row';
                
                // Bridge
                const bridge = document.createElement('div');
                bridge.className = 'bridge';
                const percent = (index / 20) * 60 + 10;
                bridge.style.right = `${percent}%`;
                row.appendChild(bridge);

                // Note Label
                const label = document.createElement('div');
                label.className = 'note-label';
                label.innerText = s.note;
                row.appendChild(label);

                // String Line
                const stringLine = document.createElement('div');
                stringLine.className = `string ${s.isGreen ? 'green' : ''}`;
                stringLine.dataset.index = index;
                stringLine.dataset.freq = s.freq;
                
                row.appendChild(stringLine);
                container.appendChild(row);
            });

            setupInteraction();
        }

        // --- Interaction Logic (Optimized) ---
        function setupInteraction() {
            const container = document.getElementById('board');
            let isDragging = false;

            const pluck = (target) => {
                if (target.classList.contains('string')) {
                    const freq = parseFloat(target.dataset.freq);
                    playSound(freq);
                    
                    // Visual feedback
                    target.classList.remove('vibrating');
                    void target.offsetWidth; 
                    target.classList.add('vibrating');
                    setTimeout(() => target.classList.remove('vibrating'), 300);
                }
            };

            // Mouse
            container.addEventListener('mousedown', (e) => {
                isDragging = true;
                pluck(e.target);
            });

            container.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const el = document.elementFromPoint(e.clientX, e.clientY);
                    // Use expanded hit area check or direct element check
                    if (el && el.classList.contains('string') && el !== window.lastPlucked) {
                        pluck(el);
                        window.lastPlucked = el;
                    }
                }
            });

            window.addEventListener('mouseup', () => {
                isDragging = false;
                window.lastPlucked = null;
            });

            // Touch - Optimized for Glissando
            container.addEventListener('touchstart', (e) => {
                e.preventDefault();
                for (let i = 0; i < e.changedTouches.length; i++) {
                    const t = e.changedTouches[i];
                    const el = document.elementFromPoint(t.clientX, t.clientY);
                    if (el) pluck(el);
                }
            }, { passive: false });

            container.addEventListener('touchmove', (e) => {
                e.preventDefault();
                for (let i = 0; i < e.changedTouches.length; i++) {
                    const t = e.changedTouches[i];
                    const el = document.elementFromPoint(t.clientX, t.clientY);
                    
                    if (el && el.classList.contains('string')) {
                        // Check against the last target specfically for this touch identifier
                        if (t.identifier !== undefined && window['lastTouch' + t.identifier] === el) {
                            continue; 
                        }
                        
                        pluck(el);
                        // Save last touched element for this specific finger
                        if (t.identifier !== undefined) {
                            window['lastTouch' + t.identifier] = el;
                        }
                    }
                }
            }, { passive: false });
            
            container.addEventListener('touchend', (e) => {
                 for (let i = 0; i < e.changedTouches.length; i++) {
                    const t = e.changedTouches[i];
                    delete window['lastTouch' + t.identifier];
                 }
            });
        }

        // --- Features ---
        function toggleNotes() {
            const board = document.getElementById('strings-area');
            board.classList.toggle('show-notes');
            const btn = document.getElementById('btn-notes');
            btn.innerText = board.classList.contains('show-notes') ? '‡∏ã‡πà‡∏≠‡∏ô‡πÇ‡∏ô‡πâ‡∏ï' : '‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏ô‡πâ‡∏ï';
        }

        function toggleRecord() {
            const btn = document.getElementById('btn-record');
            
            if (!isRecording) {
                recordedChunks = [];
                // Check if browser supports MediaRecorder
                if (!window.MediaRecorder) {
                    alert("Browser does not support recording.");
                    return;
                }
                
                try {
                    mediaRecorder = new MediaRecorder(dest.stream);
                } catch (err) {
                    alert("Recording initialization failed.");
                    return;
                }
                
                mediaRecorder.ondataavailable = (evt) => {
                    if (evt.data.size > 0) recordedChunks.push(evt.data);
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                    audioUrl = URL.createObjectURL(audioBlob);
                    document.getElementById('btn-play').disabled = false;
                    document.getElementById('btn-download').disabled = false;
                };

                mediaRecorder.start();
                isRecording = true;
                btn.innerHTML = '‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î';
                btn.classList.add('active-record');
            } else {
                mediaRecorder.stop();
                isRecording = false;
                btn.innerHTML = 'üî¥ ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
                btn.classList.remove('active-record');
            }
        }

        function playRecording() {
            if (!audioUrl) return;
            const audio = new Audio(audioUrl);
            audio.play();
        }

        function downloadRecording() {
            if (!audioUrl) return;
            const a = document.createElement('a');
            a.href = audioUrl;
            a.download = 'guzheng_recording.webm';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>